
(function () {
  // Cloudinary JSON source
const DATASET_URL =
  "https://res.cloudinary.com/dpbrqg7uz/raw/upload/v1770914996/UHC%20DATA/slktxttdr5q0yw4lwew2.json";

// Ensure DATASET exists (in case used earlier)
window.DATASET = window.DATASET || {};

// Load flag
window.datasetLoaded = false;


(async function loadDatasetFromCloudinary() {
    try {
      const response = await fetch(addCacheBuster(DATASET_URL));
      if (!response.ok) throw new Error("Failed to fetch dataset");

      const data = await response.json();

      // Replace DATASET completely (single source of truth)
      window.DATASET = data;

      window.datasetLoaded = true;

    } catch (error) {
      console.warn(
        "⚠️ Could not load DATASET from Cloudinary. Using existing DATASET.",
        error
      );
    }
  })();

  /* ================================================
FHS ONLY: State License PDF attachment mapping
================================================ */

window.FHS_STATE_LICENSE_PDFS = {
IN: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/y2eoldw1tgtkmkyq0gfi.pdf',
GA: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/gg5991bhnu7xyvypsrba.pdf',
WY: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/gzasjmn4lmbebzgavel8.pdf',
VA: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/wn33qj9k3693qg7ub9qg.pdf',
UT: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/fxjmezsjmforytji9vg0.pdf',
TX: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/hl6f6ko3qekyjugfgqb4.pdf',
NV: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/hmcyrnexdytueiiijihe.pdf',
MS: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/ivt2tvyndxaeinfkpyq9.pdf', // NOTE: you also provided a 2nd MS URL; last one wins if you prefer it
MN: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/qmm8hqyj36mmwvuyhgaj.pdf',
CA: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/rbm7cy5ddxnv9waqnx2v.pdf',
CO: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/llldpp9xbiindtnzyjjw.pdf',
FL: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/b4od5nne2osa3fdvbdmy.pdf',
WI: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/k7p1a9rjj2zdkruivamh.pdf',
WV: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/cvtmptamekj071py45iv.pdf',
TN: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/arbbk22wyugolzryxjim.pdf',
SC: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/r946syal3iqbcbedvxo6.pdf',
OK: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/aamkyxki3nh48riroh5u.pdf',
NC: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/kdlnt6vvcgjn5d1z0nqt.pdf',
MT: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/fib8m7ajmdneuwfi2nk9.pdf',
MD: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/tau6jmrejrfbtpunupyb.pdf',
KS: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/hjlfyrfx2kctageqrxvq.pdf',
IA: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/cgmthlsmrxfrhhnvygan.pdf',
IL: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/rvs52oimi5phxvnkranv.pdf',
AR: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/ld8jrj6ffmy5fudcs5vu.pdf',
AZ: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/mjf8tsl5n3yoyskp5aun.pdf',
AL: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/seewwnchfilyr0bltr00.pdf',
MO: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/z8xnlautqhhqtkoxphgp.pdf',
NJ: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/nzans8zgfy2sjvxlg84q.pdf',
};
})();
function getStateSelect() {
    return (
        document.querySelector("#manhattanPal-state") ||
        document.querySelector("#popup-state") ||
        null
    );
}
/* ================================================
 Helper: Calculate age from date of birth
 ================================================ */
// Function to calculate age from DOB (Date of Birth)
// Usage: calculateAgeFromDOB('YYYY-MM-DD') or calculateAgeFromDOB('MM/DD/YYYY')
function calculateAgeFromDOB(dob) {
  if (!dob) return '';
  
  // Parse the date - handle both YYYY-MM-DD and MM/DD/YYYY formats
  let birthDate;
  if (dob.includes('/')) {
    // MM/DD/YYYY format
    const parts = dob.split('/');
    if (parts.length === 3) {
      birthDate = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
    }
  } else if (dob.includes('-')) {
    // YYYY-MM-DD format
    birthDate = new Date(dob);
  } else {
    return '';
  }
  
  if (isNaN(birthDate.getTime())) return '';
  
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  
  // Adjust age if birthday hasn't occurred this year
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  return age >= 0 ? age : '';
}

// Auto-calculate age from DOB for form fields
// Call this function when DOB fields change
function setupDOBAgeCalculation() {
  // This function should be called on application forms
  // It looks for DOB input fields and corresponding age fields
  // Pattern: If there's an input with id/name containing 'dob' or 'date_of_birth',
  // find the corresponding age field (id/name containing 'age') and update it
  
  document.querySelectorAll('input[type="date"], input[name*="dob" i], input[name*="date_of_birth" i], input[id*="dob" i], input[id*="date_of_birth" i]').forEach(dobInput => {
    if (dobInput.dataset.ageCalculated) return; // Already set up
    
    dobInput.addEventListener('change', function() {
      const dob = this.value;
      if (!dob) return;
      
      const age = calculateAgeFromDOB(dob);
      if (age === '') return;
      
      // Try to find corresponding age field
      // Look for age field in the same row/container or with similar naming
      const form = this.closest('form');
      if (!form) return;
      
      // Try common age field patterns
      const ageField = form.querySelector('input[name*="age" i], input[id*="age" i], input[type="number"][name*="age" i]') ||
                       this.parentElement.querySelector('input[name*="age" i], input[id*="age" i]') ||
                       this.parentElement.parentElement.querySelector('input[name*="age" i], input[id*="age" i]');
      
      if (ageField) {
        ageField.value = age;
        // Trigger change event in case other code listens to it
        ageField.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
    
    dobInput.dataset.ageCalculated = 'true';
  });
}

// Auto-setup on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupDOBAgeCalculation);
} else {
  setupDOBAgeCalculation();
}

// Also setup for dynamically added forms
const observer = new MutationObserver(function(mutations) {
  setupDOBAgeCalculation();
});
observer.observe(document.body, { childList: true, subtree: true });

/* ================================================
 Helper: Send calendar booking contact to GHL (with phone number)
 ================================================ */
// Function to send calendar booking contact to GHL with phone number
// This should be called when a calendar appointment is booked (via webhook or form submission)
// Usage: sendCalendarBookingToGHL({ name: 'John Doe', email: 'john@example.com', phone: '555-1234' })
window.sendCalendarBookingToGHL = async function(bookingData) {
  const GHL_WEBHOOK_URL = 'https://services.leadconnectorhq.com/hooks/Z1YTMnrDzpEOXYq3OEos/webhook-trigger/3dc26b44-3e4c-46b4-99e1-8c0f2f39f718'; // TODO: Add your GHL webhook URL here for calendar bookings
  if (!GHL_WEBHOOK_URL || !bookingData) return;
  
  try {
    await fetch(GHL_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: bookingData.name || '',
        email: bookingData.email || '',
        phone: bookingData.phone || '', // Phone number from calendar booking form
        source: 'Calendar Booking',
        appointment_date: bookingData.appointmentDate || '',
        start_date: '2026-01-01', // Start date: 01-01-2026 (for future drip campaigns)
        coverage_start_date: '2026-01-01'
      })
    });
  } catch (err) {
    console.warn('GHL calendar booking contact creation failed:', err);
  }
};

// NOTE: To integrate with Google Calendar or other calendar platforms:
// 1. If using Calendly/Cal.com/etc., configure their webhook to call sendCalendarBookingToGHL()
// 2. If using Google Calendar API, add phone number field to booking form and send to GHL
// 3. Ensure the calendar booking form collects phone number and passes it to this function

/* ================================================
 Helper: Cache-busting for Cloudinary URLs
 ================================================ */
// Add cache-busting parameter to Cloudinary URLs to force fresh fetch
// Usage: addCacheBuster(url) or addCacheBuster(url, true) to force refresh
function addCacheBuster(url, forceRefresh = false) {
  if (!url || typeof url !== 'string') return url;
  
  // Only process Cloudinary URLs
  if (!url.includes('res.cloudinary.com')) return url;
  
  // Remove existing cache-busting parameters if forcing refresh
  if (forceRefresh) {
    url = url.split('?')[0];
  }
  
  // Add timestamp as cache-buster (updates every time function is called)
  const separator = url.includes('?') ? '&' : '?';
  return url + separator + '_t=' + Date.now();
}

/* ================================================
 Single Source of Truth: Agents JSON URL
 ================================================ */
// Agents data URL from Cloudinary - update this when you replace agents.v2.json
const AGENTS_URL = 'https://res.cloudinary.com/dpbrqg7uz/raw/upload/Agent%20details/nhukfaejceuq5fzljuck.json';
/* ================================================
 Agent Resolver (GLOBAL – DO NOT MOVE)
 ================================================ */
async function resolveAgentFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const codeFromUrl = (params.get('agent') || '').trim().toUpperCase();

  // Persist agent so it survives navigation/modals
  if (codeFromUrl) localStorage.setItem('agent_code', codeFromUrl);

  try {
    const res = await fetch(AGENTS_URL, { cache: 'no-store' });
    const data = await res.json();

    const agents = data?.agents || {};
    const stored = (localStorage.getItem('agent_code') || '').trim().toUpperCase();

    // URL → stored → JSON default
    const finalCode = codeFromUrl || stored || (data?.default || '');

    window.AGENT_SLUG = finalCode;
    window.activeAgentSlug = finalCode;

    const a = agents[finalCode];
    if (!a) {
      console.warn('Agent not found:', finalCode);
      window.ACTIVE_AGENT = null;
      return null;
    }

    window.ACTIVE_AGENT = {
      code: finalCode,
      slug: finalCode,
      name: a.name || '',
      email: a.email || '',
      phone: a.phone || '',
      calendar: a.calendar || '',
    };

    return window.ACTIVE_AGENT;
  } catch (e) {
    console.error('resolveAgentFromUrl failed:', e);
    return null;
  }
}

// Optional but recommended: resolve once on page load
resolveAgentFromUrl();

/* ================================================
 1) Your existing PLAN_DATA (unchanged)
 ================================================ */
const PLAN_DATA = {
psm: {
  title: 'Maxguard 300 Deductible',
  details: `
    <p><strong> First Health EPO Network (Aetna-Owned)</strong></p>
    <p><strong>Enrollment Fee:</strong> Zero</p>
    <p><strong>Coverage Per Person:</strong> $1 Million</p>
    <p><strong>Deductible:</strong> $300</p>
    <p><strong>Co-Pays:</strong></p>
    <ul>
      <li>Wellness: $0</li>
      <li>Primary Doctor: $50</li>
      <li>Specialist: $50</li>
      <li>Urgent Care: $50</li>
      <li>Emergency Room: $300</li>
      <li>Outpatient Surgery: $250</li>
    </ul>
    <p><strong>Co-Insurance:</strong> 0% In-Network</p>
  `,
  prices: {
    '18–29': [329, 619, 599, 849],
    '30–44': [379, 679, 649, 909],
    '45–54': [409, 699, 679, 929],
    '55–64': [449, 709, 689, 949]
  },
  ages: ['18–29', '30–44', '45–54', '55–64'],
  states: ['AK','AL','AR','AZ','CO','DC','DE','FL','GA','IA','ID','IL','IN','KS','KY','LA','MA','ME','MI','MO','MS','MT','NC','ND','NE','NJ','NM','NV','NY','OH','OK','RI','SC','SD','TN','TX','UT','VA','WV','WY'],
  summaryText: `First Health EPO network with low deductible and copays.`,
  checkLink: 'https://providerlocator.com/NewUsers.aspx',
  checkInstruction: `Provider Search Access Code: DETEGO </strong>`,
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1762960983/rjq9d5b13oixaseuchqw.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/maxguard-300-phq-1'
},

manhattan: {
  title: 'Optimum Health Saver',
  details: `
    <p><strong>First Health PPO Network (Aetna-Owned)</strong></p>
    <p><strong>Enrollment Fee:</strong>$50</p>
    <p><strong>Coverage Per Person:</strong> $500,000</p>
     <p><strong> Deductible:</strong>$5000 Hospital /Otherwise: $0</p>
    <p><strong>Co-Pays:</strong> Zero</p>
    <p><strong>Plan Design:</strong></p>
    Budget friendly PPO health plan that delivers national coverage for:
    <ul>
      <li>Wellness</li>
      <li>Doctors</li>
      <li>Urgent Care</li>
      <li>Surgery</li>
      <li>Hospitalization</li>
    </ul>
  `,
  prices: {
    '18–29': [132, 257, 273, 418],
    '30–39': [166, 325, 308, 486],
    '40–49': [197, 388, 339, 550],
    '50–64': [280, 554, 422, 715]
  },
  ages: ['18–29', '30–39', '40–49', '50–64'],
  states: ['AL','AZ','AR','FL','GA','KY','LA','MI','MS','MO','NE','NV','NC','OH','OK','SC','TN','TX','WV','WI'],
  summaryText: `No deductible, no copays, PPO network access.`,
  checkLink: 'https://www.firsthealthlbp.com/',
  // checkLink: 'https://www.firsthealthlbp.com',
  checkInstruction: `Use your ZIP to search providers`,
  // benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763145497/rux6q1guicvol6mc1zns.pdf',
  license_pdf:'https://res.cloudinary.com/dpbrqg7uz/image/upload/State%20Licenses/y2eoldw1tgtkmkyq0gfi.pdf',
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1767367114/fzdk5btw6hanxjapevkf.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/optimum-app-1'
},

silver: {
  title: 'LifeX VL 500 Deductible',
  details: `
    <p><strong>MultiPlan PHCS Extended PPO Network</strong></p>
    <p>Wide national access to over 700,000 providers—no referrals.</p>
    <p><strong>Enrollment Fee:</strong> $0</p>
    <p><strong>Coverage Limit:</strong> $1,000,000 per person/year (covered services)</p>
    <p><strong>Deductible:</strong> $500</p>
    <p><strong>Co-Pays:</strong></p>
    <ul>
      <li>Wellness visit: $0</li>
      <li>Primary care: $50</li>
      <li>Specialist: $50</li>
      <li>Urgent care: $50</li>
      <li>Emergency room: $500</li>
      <li>Outpatient surgery: $250</li>
    </ul>
    <p><strong>No Co-Insurance:</strong> 0% extra in-network on covered services.</p>
  `,
  prices: {
    '18–29': [329, 658, 648, 905],
    '30–44': [390, 699, 689, 967],
    '45–54': [421, 741, 730, 1019],
    '55–64': [473, 761, 741, 1060]
  },
  states: ['AL','AR','AZ','CA','CO','CT','DC','DE','FL','GA','IA','ID','IL','IN','KS','KY','LA','MA','ME','MI','MO','MS','MT','NC','ND','NE','NJ','NM','NV','NY','OH','OK','PA','RI','SC','SD','TN','TX','UT','VA','WI','WV','WY'],
  summaryText: `Low $500 deductible, zero coinsurance, PHCS Extended PPO access.`,
  checkLink: 'https://www.multiplan.com/webcenter/portal/ProviderSearch',
  checkInstruction: `Select <strong>PHCS Extended PPO</strong>`,
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763212557/bccvet8gjflmpqexqqmc.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/phcs-250-phq-1'
},

seven: {
  title: 'LifeX 7250 Deductible',
  details: `
    <p><strong>Cigna PPO Network</strong></p>
    <p><strong>Enrollment Fee:</strong> $0</p>
    <p><strong>Coverage:</strong> Unlimited</p>
    <p><strong>Deductible:</strong> $7,250</p>
    <p><strong>Max Out-of-Pocket:</strong> $10,150</p>
    <p><strong>Co-Pays:</strong></p>
    <ul>
      <li>Wellness: $0</li>
      <li>Primary: $25</li>
      <li>Specialist: $40</li>
      <li>Urgent care: $60</li>
      <li>Chiropractor: $30</li>
    </ul>
    <p>*First-day copays—no deductible needed for these.</p>
  `,
  prices: {
    '18–29': [582, 978, 905, 1379],
    '30–44': [596, 1007, 931, 1423],
    '45–54': [620, 1049, 969, 1483],
    '55–64': [652, 1118, 1031, 1590]
  },
  states: ['AL','AR','AZ','CA','CO','CT','DC','DE','FL','GA','IA','ID','IL','IN','KS','KY','LA','MA','ME','MI','MO','MS','MT','NC','ND','NE','NJ','NM','NV','NY','OH','OK','PA','RI','SC','SD','TN','TX','UT','VA','WI','WV','WY'],
  summaryText: `Unlimited coverage with low copays via Cigna PPO.`,
  checkLink: 'https://hcpdirectory.cigna.com/web/public/consumer/directory',
  checkInstruction: `Select <strong>Employer or School</strong>`,
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763212065/ytplxbkd5wn2xey8futk.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/cigna-7250-phq-1'
},

five: {
  title: 'GIGCARE 7350 DEDUCTIBLE',
  details: `
    <p><strong>Blue Cross Blue Shield EPO Network</strong></p>
    <p><strong>Enrollment Fee:</strong> Zero</p>
    <p><strong>Coverage:</strong> Unlimited</p>
    <p><strong>Deductible:</strong> $7,350</p>
    <p><strong>Max Out-of-Pocket:</strong> $9,200</p>
    <p><strong>Co-Pays:</strong></p>
    <ul>
      <li>Wellness: $0</li>
      <li>Primary Doctor: $25</li>
      <li>Specialist: $40</li>
      <li>Urgent Care: $100</li>
      <li>Mental Health Therapy: $25</li>
    </ul>
    <p><strong>*No deductible required for the above copays</strong></p>
  `,
  prices: {
    '18–29': [600, 1071, 979, 1548],
    '30–44': [619, 1108, 1013, 1603],
    '45–54': [642, 1155, 1054, 1673],
    '55–64': [690, 1250, 1140, 1815]
  },
  states: ['AK','AL','AR','AZ','CO','DC','DE','FL','GA','IA','ID','IL','IN','KS','KY','LA','MA','ME','MI','MO','MS','MT','NC','ND','NE','NJ','NM','NV','NY','OH','OK','RI','SC','SD','TN','TX','UT','VA','WV','WY'],
  summaryText: `National EPO, $9,200 max OOP.`,
  checkLink: 'https://bcbsneweb.healthsparq.com/healthsparq/public/#/one/city=&state=&postalCode=&country=&insurerCode=BCBSNE_I&brandCode=BCBSNE&alphaPrefix=&bcbsaProductId=&productCode=0351000057',
  checkInstruction: `Select <strong>Network BLUE</strong>`,
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1762971401/a1gvqwvt78odnsgtnnvj.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/psm-bcbs-7350-phq-1'
},

three: {
  title: 'GIGCARE 2500 DEDUCTIBLE',
  details: `
    <p><strong>Blue Cross Blue Shield PPO Network</strong></p>
    <p><strong>Enrollment Fee:</strong> Zero</p>
    <p><strong>Coverage:</strong> Unlimited</p>
    <p><strong>Deductible:</strong> $2,500</p>
    <p><strong>Max Out-of-Pocket:</strong> $8,500</p>
    <p><strong>Co-Pays:</strong></p>
    <ul>
      <li>Wellness: $0</li>
      <li>Primary Doctor: $25</li>
      <li>Specialist: $40</li>
      <li>Urgent Care: $60</li>
      <li>Mental Health Therapy: $25</li>
    </ul>
    <p><strong>*No deductible required for the above copays</strong></p>
  `,
  prices: {
    '18–29': [821, 1513, 1377, 2210],
    '30–44': [849, 1568, 1426, 2292],
    '45–54': [890, 1650, 1500, 2416],
    '55–64': [994, 1858, 1687, 2728]
  },
  states: ['AK','AL','AR','AZ','CO','DC','DE','FL','GA','IA','ID','IL','IN','KS','KY','LA','MA','ME','MI','MO','MS','MT','NC','ND','NE','NJ','NM','NV','NY','OH','OK','RI','SC','SD','TN','TX','UT','VA','WV','WY'],
  summaryText: `PPO plan with $8,500 max OOP.`,
  checkLink: 'https://bcbsneweb.healthsparq.com/healthsparq/public/#/one/city=&state=&postalCode=&country=&insurerCode=BCBSNE_I&brandCode=BCBSNE&alphaPrefix=&bcbsaProductId=&productCode=0351000057',
  checkInstruction: `Select <strong>Network BLUE</strong>`,
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1762960984/plod51dzlidnyqdizrza.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/psm-bcbs-2500-phq-1'
},

/* === NEW PLANS === */
iec: {
  title: 'LifeX MM 500 Deductible',
  details: `
    <p><strong>Network:</strong> Cigna EPO Network</p>
    <p><strong>Enrollment Fee:</strong> $0</p>
    <p><strong>Coverage Limit:</strong> Unlimited (covered services)</p>
    <p><strong>Deductible:</strong>$500</p>
    <p><strong>Max OOP:</strong>$9200</p>
    <p><strong>Co-Pays:</strong></p>
    <ul>
      <li>Wellness: $0</li>
      <li>Primary: $50</li>
      <li>Specialist: $50</li>
      <li>Urgent Care: $50</li>
      <li>ER: $1000</li>
      <li>Surgery: $2750</li>
    </ul>
  `,
  prices: {
    '18–29': [429, 789, 779, 1059],
    '30–44': [489, 829, 819, 1119],
    '45-54': [519, 869, 859, 1169],
    '55–64': [569, 889, 869, 1209]
  },
  ages: ['18–29', '30–44', '45–54', '55–64'],
  states: ['AL','AR','AZ','CA','CO','CT','DC','DE','FL','GA','IA','ID','IL','IN','KS','KY','LA','MA','ME','MI','MO','MS','MT','NC','ND','NE','NJ','NM','NV','NY','OH','OK','PA','RI','SC','SD','TN','TX','UT','VA','WI','WV','WY'],  summaryText: ``,
  checkLink: 'https://hcpdirectory.cigna.com/web/public/consumer/directory',
  checkInstruction: `Use your ZIP to search participating providers.`,
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763212438/j1vaq2ugh9khbfzqydqx.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/cigna-500-epo-phq-1'
},
hcs: {
  title: 'UHC Premier 5000',
  subtitle: 'Small Group (2–9 Employees)',
  details: `
    <p><strong>United Healthcare Choice Plus PPO Network</strong></p>

    <p><strong>Enrollment Fee:</strong> Zero</p>
    <p><strong>Coverage:</strong> $2 Million</p>
    <p><strong>Deductible:</strong> Zero</p>
    <p><strong>Co-Pays:</strong> Zero</p>
  <p><strong>Plan Design:</strong> </p>

Budget friendly PPO health plan that delivers national coverage for:
    <ul>
      <li>Wellness</li>
      <li>Doctors</li>
      <li>Urgent Care</li>
      <li>Surgery</li>
      <li>Hospitalization</li>
    </ul>
  `,
  prices: { '18–64': [587, 1090, 994, 1582] },
  ages: ['18–64'],
  states:  DATASET?._meta?.states_filtered || [],
  summaryText: `No deductible, no copays, PPO network access.`,
  checkLink: 'https://connect.werally.com/guest/eyJwbGFuTmFtZSI6IkNob2ljZSBQbHVzIE5ldHdvcmsiLCJkZWxzeXMiOiIxMDE4OCIsImNvdmVyYWdlVHlwZSI6Im1lZGljYWwiLCJwYXJ0bmVySWQiOiJ1aGMiLCJsYW5ndWFnZSI6ImVuIiwic2hvd0Nvc3RzIjp0cnVlfQAIMtmbWINHMd4i4g3HSNnJvnYQRfXxlYm7ekSxMAbUo',
  checkInstruction: `Select <strong>Use your ZIP to search providers </strong>.`,
  benefits: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1769395006/q5wyhgsmibkjyqvccovp.pdf',
  apply: 'https://firsthealth-insurancesolutions.com/uhc-5000-app'
}
};
const waitForDataset = setInterval(() => {
  if (window.datasetLoaded && DATASET._meta?.states_filtered) {
    clearInterval(waitForDataset);

    PLAN_DATA.hcs.states = [...DATASET._meta.states_filtered];

    console.log('✅ hcs.states injected from DATASET');
  }
}, 50);

/* ================================================
 2) FL exact-age rates for Manhattan (Affordable Choice Elite)
    Columns: [Individual, Individual+Spouse, Individual+Children, Family]
 ================================================ */
const MANHATTAN_FL_RATES = {
18:[123,231,216,340],19:[126,236,220,348],20:[129,241,225,355],21:[132,246,230,363],
22:[135,252,235,371],23:[138,257,240,379],24:[142,263,246,388],25:[145,269,251,397],
26:[149,275,257,406],27:[152,282,263,414],28:[156,296,268,424],29:[160,303,274,433],
30:[163,309,280,442],31:[167,316,285,451],32:[170,322,291,460],33:[174,329,297,468],
34:[177,336,302,478],35:[181,342,308,486],36:[184,348,313,494],37:[187,354,318,502],
38:[191,360,323,510],39:[194,366,328,519],40:[197,371,333,526],41:[200,377,339,535],
42:[204,383,344,543],43:[207,389,349,551],44:[210,395,354,559],45:[217,407,364,575],
46:[223,419,374,591],47:[230,431,385,606],48:[237,443,395,622],49:[243,454,405,638],
50:[250,466,415,654],51:[257,478,425,670],52:[263,490,436,686],53:[270,501,446,702],
54:[276,513,456,717],55:[283,525,466,733],56:[290,537,476,749],57:[296,549,487,765],
58:[303,561,497,781],59:[310,573,508,798],60:[317,586,519,815],61:[325,599,530,833],
62:[332,613,542,851],63:[340,626,554,870],64:[348,641,566,889],
};

/* Display list for FL: every age 18..64 */
const MANHATTAN_FL_AGES_DISPLAY = Array.from({ length: 47 }, (_, i) => String(18 + i));

/* ================================================
 3) Main app logic (popup UI, pricing, etc.)
 ================================================ */
document.addEventListener('DOMContentLoaded', () => {
document.getElementById("manhattanPal-output").style.display='none';
const popup = document.getElementById("plan-popup");
const titleEl = document.getElementById("popup-title");
const detailsEl = document.getElementById("popup-details");
const ageSel = document.getElementById("popup-age");
const stateSel = document.getElementById("popup-state");
const calcBtn = document.getElementById("popup-calc");
const pricesEl = document.getElementById("popup-prices");
const summaryEl = document.getElementById("popup-summary");
const vbLink = document.getElementById("popup-benefits");
  const apLink = document.getElementById("popup-apply");
function agentify(url){
try {
  if (!(window.Agent && Agent.exists)) return url;
  return Agent.withParam(url);
} catch { return url; }
}

// 1) When the popup opens, pre-stamp Apply with agent
// (you already set apLink.href elsewhere — this enforces it)
function setApplyHref(baseUrl){
apLink.href = agentify(baseUrl || '#');
}

// 2) When a price is picked, preserve agent AND add price
function setApplyHrefWithPrice(baseUrl, price){
const stamped = agentify(baseUrl || '#');
const u = new URL(stamped, location.origin);
if (price != null) u.searchParams.set('price', String(price));
apLink.href = u.toString();
}

// 3) Just-in-time safeguard: stamp right before navigation
apLink.addEventListener('click', (e) => {
const current = apLink.getAttribute('href') || (activePlan?.apply || '#');
const finalHref = agentify(current);
if (finalHref !== current) {
  e.preventDefault();
  window.open(finalHref, '_blank');  // keeps your target behavior
}
});
const popupClose = document.getElementById("popup-close");

let activePlan = null;
let activePlanKey = null; // NEW: which plan is open

// --- Scroll lock helpers
function lockScroll(lock){ document.body.classList.toggle('modal-open', !!lock); }
function isAnyOverlayOpen(){
  return !!document.querySelector('.popup.active, .modal[style*="display: block"]');
}

// --- Popup helpers
function resetPopup() {

  ageSel.value = "";
  stateSel.value = "";
  ageSel.disabled = false;
  stateSel.disabled = false;
  pricesEl.innerHTML = "";
  summaryEl.innerHTML = "";
  document.querySelector(".view-benefits").style.display = "none";
  document.querySelector(".apply-now").style.display = "none";
  calcBtn.style.display = "block";
  calcBtn.disabled = true;
  document.querySelector('#manhattanPal-state').disabled = false;
  
  // Reset Manhattan PAL calculator if it was used
  if (activePlanKey === 'manhattan') {
    manhattanPal_resetAll();
    document.getElementById("manhattanPal-output").style.display='none';
  }
  // Reset medication search section visibility and clear results
  const medicationSearchSection = document.querySelector('.medication-search-section');
  if (medicationSearchSection) {
    medicationSearchSection.style.display = 'block'; // Default to visible, will be hidden by plan-specific logic
  }
  // Clear medication search input and result
  const medicationSearchInput = document.getElementById('medication-search-input');
  const medicationSearchResult = document.getElementById('medication-search-result');
  if (medicationSearchInput) medicationSearchInput.value = '';
  if (medicationSearchResult) {
    medicationSearchResult.textContent = '';
    medicationSearchResult.style.display = 'none';
    medicationSearchResult.style.backgroundColor = '';
    medicationSearchResult.style.color = '';
    medicationSearchResult.style.border = '';
  }
  // Reset search button state
  const medicationSearchBtn = document.getElementById('medication-search-btn');
  if (medicationSearchBtn) {
    medicationSearchBtn.disabled = false;
    medicationSearchBtn.textContent = 'Search';
  }
}
function updateCalcBtnState() {
  calcBtn.disabled = !(ageSel.value && stateSel.value);
}
function populateSelect(el, options, placeholder) {
  el.innerHTML = `<option disabled selected value="">${placeholder}</option>` +
    options.map(o => `<option value="${o}">${o}</option>`).join("");
}

/* ===== Manhattan: ONLY switch age list when entering/leaving FL ===== */
function refreshAgeOptionsForManhattan() {
  if (activePlanKey !== 'manhattan') return;

  const isFL     = (stateSel.value === 'FL');
  const wasExact = (ageSel.dataset.rateMode === 'exact');

  const keepIfPossible = (prev) => {
    if (!prev) return;
    const opts = Array.from(ageSel.options).map(o => o.value);
    if (opts.includes(prev)) ageSel.value = prev;
  };

  // Enter FL -> exact ages 18..64
  if (isFL && !wasExact) {
    const prev = ageSel.value;
    populateSelect(ageSel, MANHATTAN_FL_AGES_DISPLAY, 'Choose Age');
    ageSel.dataset.rateMode = 'exact';
    keepIfPossible(prev);
    updateCalcBtnState();
    return;
  }

  // Leave FL -> back to bands
  if (!isFL && wasExact) {
    const prev = ageSel.value;
    populateSelect(ageSel, Object.keys(activePlan.prices), 'Choose Age');
    ageSel.dataset.rateMode = 'band';
    keepIfPossible(prev);
    updateCalcBtnState();
  }
}

/* ================================================
   Manhattan PAL Calculator Logic (namespaced)
   ================================================ */
// Manhattan PAL Constants
const MANHATTAN_PAL_FEMALE_BASE_BY_AGE = {
  21:129, 22:129, 23:129, 24:129, 25:129,
  26:131, 27:133, 28:136, 29:139, 30:140,
  31:144, 32:147, 33:151, 34:154, 35:158,
  36:162, 37:166, 38:170, 39:174, 40:178,
  41:185, 42:192, 43:199, 44:207, 45:214,
  46:221, 47:228, 48:235, 49:243, 50:250
};

const MANHATTAN_PAL_TOBACCO_RATE_BY_AGE = {
  21:0.091549296, 22:0.091549296, 23:0.091549296, 24:0.091549296,
  25:0.110344828, 26:0.114864865, 27:0.119205298, 28:0.116883117,
  29:0.120253165, 30:0.135802469, 31:0.137724551, 32:0.140350877,
  33:0.142045455, 34:0.144444444, 35:0.145945946, 36:0.147368421,
  37:0.148717949, 38:0.15,         39:0.151219512, 40:0.168224299,
  41:0.170403587, 42:0.172413793, 43:0.174273859, 44:0.172,
  45:0.173745174, 46:0.175373134, 47:0.179856115, 48:0.181184669,
  49:0.179054054, 50:0.188311688
};

const MANHATTAN_PAL_CHILD_ADD = 78;

function manhattanPal_diabetesRateForAge(age){
  if (age >= 36 && age <= 50) return 0.2;
  return null; // does not qualify
}

const MANHATTAN_PAL_STATE_ABBRS = [
  "AL","AZ","AR","FL","GA","KY","LA","MI","MS","MO",
  "NE","NV","NC","OH","OK","SC","TN","TX","WV","WI"
];
// Manhattan PAL Helper Functions
function manhattanPal_$(id) { return document.getElementById(id); }
function manhattanPal_show(id) { manhattanPal_$(id).classList.remove("manhattanPal-hidden"); }
function manhattanPal_hide(id) { manhattanPal_$(id).classList.add("manhattanPal-hidden"); }

function manhattanPal_money(n){
  return (Math.round(n * 100) / 100).toLocaleString(undefined, {style:"currency", currency:"USD"});
}
function manhattanPal_pct(n){ return (n * 100).toFixed(2) + "%"; }

function manhattanPal_fillSelect(selectEl, opts, placeholderText){
  selectEl.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = placeholderText;
  ph.disabled = true;
  ph.selected = true;
  selectEl.appendChild(ph);
  opts.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = String(o.value ?? o);
    opt.textContent = String(o.label ?? o);
    selectEl.appendChild(opt);
  });
}

function manhattanPal_enableViewBtn(on){
  const btn = manhattanPal_$("manhattanPal-viewBtn");
  if (on) btn.classList.remove("manhattanPal-disabled");
  else btn.classList.add("manhattanPal-disabled");
}

function manhattanPal_getAdultFinal(age, tobaccoYes, diabetesYes){
  const base = MANHATTAN_PAL_FEMALE_BASE_BY_AGE[age];
  if (!base && window.activePlanKey!="hcs") return { ok:false, reason:`Age ${age} is not in the valid range (21-50).` };
  
  const tobRate = tobaccoYes ? (MANHATTAN_PAL_TOBACCO_RATE_BY_AGE[age] || 0) : 0;

let diabRate = 0;

if (diabetesYes) {
  const r = manhattanPal_diabetesRateForAge(age);

  if (r === null) {
    const suitablePlans = [
      { key: "psm",   label: "Maxguard 300 Deductible" },
      { key: "silver",label: "LifeX VL 500 Deductible" },
      { key: "iec",   label: "LifeX MM 500 Deductible" },
      { key: "seven", label: "LifeX 7250 Deductible" },
      { key: "five",  label: "GIGCARE 7350 Deductible" },
      { key: "three", label: "GIGCARE 2500 Deductible" },
    ];


    myHintPopup(
      "open",
      "Not eligible for this plan",
      `
        <div class="hintAlert">
          <div class="hintAlertIcon" aria-hidden="true">!</div>
          <div class="hintAlertBody">
            <div class="hintAlertTitle">
              This plan is not suitable for diabetes ages 21–35
            </div>
            <div class="hintAlertText">
Below are diabetes-eligible plans, ordered by price; lowest to highest.
            </div>
          </div>
        </div>

        ${renderPlanButtons(suitablePlans)}

        <div class="hintFootnote">
          Your selection will open the plan pricing popup.
        </div>
      `
    );

    return { ok: false, reason: `Age ${age}: Diabetes = Does Not Qualify (allowed 36–50 only).` };
  }

  diabRate = r;
}

  const final = base * (1 + tobRate + diabRate);
  return { ok:true, base, tobRate, diabRate, final };
}

function manhattanPal_primaryComplete(){
  if(window.activePlanKey==="hcs"){
    // Show Area
     manhattanPal_show("manhattanPal-primaryGenderDiv");
     //Hide Area
     manhattanPal_hide("manhattanPal-primaryDiabetesDiv");
     manhattanPal_hide("manhattanPal-spouseDiabetesDiv");

      return manhattanPal_$("manhattanPal-primaryAge").value && 
         manhattanPal_$("manhattanPal-primaryTobacco").value && 
         manhattanPal_$("manhattanPal-primaryGender").value;
  }else{
      // Show Area
    manhattanPal_show("manhattanPal-primaryDiabetesDiv");
    manhattanPal_show("manhattanPal-spouseDiabetesDiv");
    manhattanPal_show("manhattanPal-spouseGenderDiv");
    //Hide Area
  manhattanPal_hide("manhattanPal-primaryGenderDiv");
      return manhattanPal_$("manhattanPal-primaryAge").value && 
         manhattanPal_$("manhattanPal-primaryTobacco").value && 
         manhattanPal_$("manhattanPal-primaryDiabetes").value;
  }

}
function manhattanPal_spouseChoiceSelected(){
  return manhattanPal_$("manhattanPal-addSpouse").value;
}
function manhattanPal_spouseComplete(){
   if(window.activePlanKey==="hcs"){
    manhattanPal_show("manhattanPal-spouseGenderDiv");
    return manhattanPal_$("manhattanPal-spouseAge").value && 
         manhattanPal_$("manhattanPal-spouseTobacco").value
       }
    else{
      manhattanPal_hide("manhattanPal-spouseGenderDiv");
      return manhattanPal_$("manhattanPal-spouseAge").value && 
         manhattanPal_$("manhattanPal-spouseTobacco").value && 
         manhattanPal_$("manhattanPal-spouseDiabetes").value;
    }
  
}
function manhattanPal_childrenSelected(){
  return manhattanPal_$("manhattanPal-childrenCount").value !== "";
}

function manhattanPal_lockPrimaryIntoSummary(){
  const age = manhattanPal_$("manhattanPal-primaryAge").value;
  const tob = manhattanPal_$("manhattanPal-primaryTobacco").value === "yes" ? "Yes" : "No";
  const dia = manhattanPal_$("manhattanPal-primaryDiabetes").value === "yes" ? "Yes" : "No";
  const primaryGender = manhattanPal_$("manhattanPal-primaryGender").value || '';
  if(window.activePlanKey==="hcs"){
      manhattanPal_$("manhattanPal-primarySummaryText").innerHTML =
    `<span>Primary age:</span> ${age} &nbsp; <span>Tabacco:</span> ${tob} &nbsp; <span>Gender:</span> ${primaryGender.toUpperCase()}`;
  }
    else{
        manhattanPal_$("manhattanPal-primarySummaryText").innerHTML =
    `<span>Primary age:</span> ${age} &nbsp; <span>Tabacco:</span> ${tob} &nbsp; <span>Diabetes:</span> ${dia}`;
    }


  manhattanPal_hide("manhattanPal-primaryInputs");
  manhattanPal_show("manhattanPal-primarySummary");
  manhattanPal_show("manhattanPal-addSpouseField");
}

function manhattanPal_clearSpouseAndChildrenFlow(){
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-addSpouse"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
  manhattanPal_hide("manhattanPal-addSpouseField");
  manhattanPal_hide("manhattanPal-spouseChoiceSummary");
  manhattanPal_$("manhattanPal-spouseChoiceSummaryText").textContent = "";

  const ages = [];
  for (let a=21; a<=50; a++) ages.push(a);
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseAge"), ages.map(a=>({value:a,label:a})), "Choose Age");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseTobacco"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseDiabetes"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");

  manhattanPal_hide("manhattanPal-spouseInputs");
  manhattanPal_hide("manhattanPal-spouseSummary");
  manhattanPal_$("manhattanPal-spouseSummaryText").textContent = "";

  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-childrenCount"), [
    {value:0,label:"No"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},
    {value:4,label:"4"},{value:5,label:"5"},{value:6,label:"6"}
  ], "Select");
  manhattanPal_hide("manhattanPal-childrenField");
  manhattanPal_hide("manhattanPal-childrenSummary");
  manhattanPal_$("manhattanPal-childrenSummaryText").textContent = "";

  manhattanPal_enableViewBtn(false);
  manhattanPal_$("manhattanPal-breakdown").innerHTML = "";
  manhattanPal_$("manhattanPal-total").textContent = "$0.00";
  document.getElementById("manhattanPal-output").style.display='none';
}

function manhattanPal_unlockPrimaryForEdit(){
  manhattanPal_hide("manhattanPal-primarySummary");
  manhattanPal_show("manhattanPal-primaryInputs");
  manhattanPal_clearSpouseAndChildrenFlow();
}

function manhattanPal_lockSpouseChoiceIntoSummary(){
  const yesNo = manhattanPal_$("manhattanPal-addSpouse").value === "yes" ? "Yes" : "No";
  manhattanPal_$("manhattanPal-spouseChoiceSummaryText").innerHTML = `<span>Add Spouse?</span> ${yesNo}`;

  manhattanPal_hide("manhattanPal-addSpouseField");
  manhattanPal_show("manhattanPal-spouseChoiceSummary");
}

function manhattanPal_unlockSpouseChoiceForEdit(){
  manhattanPal_hide("manhattanPal-spouseChoiceSummary");
  manhattanPal_show("manhattanPal-addSpouseField");

  const ages = [];
  for (let a=21; a<=50; a++) ages.push(a);
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseAge"), ages.map(a=>({value:a,label:a})), "Choose Age");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseTobacco"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseDiabetes"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
  manhattanPal_hide("manhattanPal-spouseInputs");
  manhattanPal_hide("manhattanPal-spouseSummary");
  manhattanPal_$("manhattanPal-spouseSummaryText").textContent = "";

  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-childrenCount"), [
    {value:0,label:"No"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},
    {value:4,label:"4"},{value:5,label:"5"},{value:6,label:"6"}
  ], "Select");
  manhattanPal_hide("manhattanPal-childrenField");
  manhattanPal_hide("manhattanPal-childrenSummary");
  manhattanPal_$("manhattanPal-childrenSummaryText").textContent = "";

  manhattanPal_enableViewBtn(false);
  manhattanPal_$("manhattanPal-breakdown").innerHTML = "";
  manhattanPal_$("manhattanPal-total").textContent = "$0.00";
  document.getElementById("manhattanPal-output").style.display='none';
}

function manhattanPal_lockSpouseIntoSummary(){
  const age = manhattanPal_$("manhattanPal-spouseAge").value;
  const tob = manhattanPal_$("manhattanPal-spouseTobacco").value === "yes" ? "Yes" : "No";
  const dia = manhattanPal_$("manhattanPal-spouseDiabetes").value === "yes" ? "Yes" : "No";
 if(window.activePlanKey==="hcs"){
  var spouseGender = manhattanPal_$("manhattanPal-spouseGender").value || "";
   manhattanPal_$("manhattanPal-spouseSummaryText").innerHTML =
    `<span>Spouse age:</span> ${age} &nbsp; <span>Tabacco:</span> ${tob} &nbsp; <span>Gender:</span> ${spouseGender.toUpperCase()}`;}
 
  else{ manhattanPal_$("manhattanPal-spouseSummaryText").innerHTML =
    `<span>Spouse age:</span> ${age} &nbsp; <span>Tabacco:</span> ${tob} &nbsp; <span>Diabetes:</span> ${dia}`;}
 

  manhattanPal_hide("manhattanPal-spouseInputs");
  manhattanPal_show("manhattanPal-spouseSummary");
  manhattanPal_show("manhattanPal-childrenField");
}

function manhattanPal_unlockSpouseForEdit(){
  manhattanPal_hide("manhattanPal-spouseSummary");
  manhattanPal_show("manhattanPal-spouseInputs");

  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-childrenCount"), [
    {value:0,label:"No"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},
    {value:4,label:"4"},{value:5,label:"5"},{value:6,label:"6"}
  ], "Select");
  manhattanPal_hide("manhattanPal-childrenField");
  manhattanPal_hide("manhattanPal-childrenSummary");
  manhattanPal_$("manhattanPal-childrenSummaryText").textContent = "";

  manhattanPal_enableViewBtn(false);
  manhattanPal_$("manhattanPal-breakdown").innerHTML = "";
  manhattanPal_$("manhattanPal-total").textContent = "$0.00";
  document.getElementById("manhattanPal-output").style.display='none';
}

function manhattanPal_lockChildrenIntoSummary(){
  const n = parseInt(manhattanPal_$("manhattanPal-childrenCount").value, 10);
  const text = (n === 0) ? "No" : String(n);
  manhattanPal_$("manhattanPal-childrenSummaryText").innerHTML = `<span>Add Children?</span> ${text}`;

  manhattanPal_hide("manhattanPal-childrenField");
  manhattanPal_show("manhattanPal-childrenSummary");
}

function manhattanPal_unlockChildrenForEdit(){
  manhattanPal_hide("manhattanPal-childrenSummary");
  manhattanPal_show("manhattanPal-childrenField");

  manhattanPal_enableViewBtn(false);
  manhattanPal_$("manhattanPal-breakdown").innerHTML = "";
  manhattanPal_$("manhattanPal-total").textContent = "$0.00";
  document.getElementById("manhattanPal-output").style.display='none';
}

function manhattanPal_flowUpdate(){
  const hasState = !!manhattanPal_$("manhattanPal-state").value;

  if (!hasState){
    manhattanPal_hide("manhattanPal-primaryInputs"); manhattanPal_hide("manhattanPal-primarySummary");
    manhattanPal_hide("manhattanPal-addSpouseField"); manhattanPal_hide("manhattanPal-spouseChoiceSummary");
    manhattanPal_hide("manhattanPal-spouseInputs"); manhattanPal_hide("manhattanPal-spouseSummary");
    manhattanPal_hide("manhattanPal-childrenField"); manhattanPal_hide("manhattanPal-childrenSummary");
    manhattanPal_enableViewBtn(false);
    return;
  }

  // PRIMARY stage
  if (manhattanPal_$("manhattanPal-primarySummary").classList.contains("manhattanPal-hidden")){
    manhattanPal_show("manhattanPal-primaryInputs");
    if (manhattanPal_primaryComplete()) manhattanPal_lockPrimaryIntoSummary();
    else{
      manhattanPal_hide("manhattanPal-addSpouseField"); manhattanPal_hide("manhattanPal-spouseChoiceSummary");
      manhattanPal_hide("manhattanPal-spouseInputs"); manhattanPal_hide("manhattanPal-spouseSummary");
      manhattanPal_hide("manhattanPal-childrenField"); manhattanPal_hide("manhattanPal-childrenSummary");
      manhattanPal_enableViewBtn(false);
      return;
    }
  }

  // SPOUSE choice stage
  if (!manhattanPal_spouseChoiceSelected()){
    manhattanPal_show("manhattanPal-addSpouseField");
    manhattanPal_hide("manhattanPal-spouseChoiceSummary");
    manhattanPal_hide("manhattanPal-spouseInputs"); manhattanPal_hide("manhattanPal-spouseSummary");
    manhattanPal_hide("manhattanPal-childrenField"); manhattanPal_hide("manhattanPal-childrenSummary");
    manhattanPal_enableViewBtn(false);
    return;
  }

  // lock spouse choice summary (Yes/No)
  if (manhattanPal_$("manhattanPal-spouseChoiceSummary").classList.contains("manhattanPal-hidden")){
    manhattanPal_lockSpouseChoiceIntoSummary();
  }

  if (manhattanPal_$("manhattanPal-addSpouse").value === "yes"){
    // show spouse inputs until complete, then lock details
    if (manhattanPal_$("manhattanPal-spouseSummary").classList.contains("manhattanPal-hidden")){
      manhattanPal_show("manhattanPal-spouseInputs");
      if (manhattanPal_spouseComplete()) manhattanPal_lockSpouseIntoSummary();
      else{
        manhattanPal_hide("manhattanPal-childrenField"); manhattanPal_hide("manhattanPal-childrenSummary");
        manhattanPal_enableViewBtn(false);
        return;
      }
    } else {
      manhattanPal_hide("manhattanPal-spouseInputs");
      manhattanPal_show("manhattanPal-childrenField");
    }
  } else {
    manhattanPal_hide("manhattanPal-spouseInputs");
    manhattanPal_hide("manhattanPal-spouseSummary");
    manhattanPal_show("manhattanPal-childrenField");
  }

  // CHILDREN stage
  if (!manhattanPal_childrenSelected()){
    manhattanPal_hide("manhattanPal-childrenSummary");
    manhattanPal_show("manhattanPal-childrenField");
    manhattanPal_enableViewBtn(false);
    return;
  }

  // once selected, close children into summary
  if (manhattanPal_$("manhattanPal-childrenSummary").classList.contains("manhattanPal-hidden")){
    manhattanPal_lockChildrenIntoSummary();
  }

  manhattanPal_enableViewBtn(true);
}

function manhattanPal_viewPremiums(){
   var benefits_link= addCacheBuster(PLAN_DATA[window.activePlanKey].benefits);
   var apply_link= addCacheBuster(PLAN_DATA[window.activePlanKey].apply);

  if (manhattanPal_$("manhattanPal-viewBtn").classList.contains("manhattanPal-disabled")) return;
  
  document.querySelectorAll('.manhattanPal-editBtn').forEach(btn => {
   btn.classList.add('manhattanPal-hidden');
  });
  document.querySelector('#manhattanPal-state').disabled = true;

   var str="";
  const state = manhattanPal_$("manhattanPal-state").value;

  const primaryAge = parseInt(manhattanPal_$("manhattanPal-primaryAge").value, 10);
  var primaryGender = manhattanPal_$("manhattanPal-primaryGender").value || "";
  var spouseGender = manhattanPal_$("manhattanPal-spouseGender").value || "";

  const pT = manhattanPal_$("manhattanPal-primaryTobacco").value === "yes";
  const pD = manhattanPal_$("manhattanPal-primaryDiabetes").value === "yes";

  const addSpouse = manhattanPal_$("manhattanPal-addSpouse").value === "yes";

  const children = parseInt(manhattanPal_$("manhattanPal-childrenCount").value, 10);

  const primary = manhattanPal_getAdultFinal(primaryAge, pT, pD);
  if (!primary.ok){
    manhattanPal_$("manhattanPal-breakdown").innerHTML = `<div class="manhattanPal-bad">${primary.reason}</div>`;
    manhattanPal_$("manhattanPal-total").textContent = "$0.00";
    document.getElementById("manhattanPal-output").style.display='none';
    return;
  }

  let spouse = null;
  let sAge=null, sT=false, sD=false;
   let total = childTotal=0;
  if (addSpouse){
    sAge = parseInt(manhattanPal_$("manhattanPal-spouseAge").value, 10);
    sT = manhattanPal_$("manhattanPal-spouseTobacco").value === "yes";
    sD = manhattanPal_$("manhattanPal-spouseDiabetes").value === "yes";
    spouse = manhattanPal_getAdultFinal(sAge, sT, sD);
    if (!spouse.ok){
      manhattanPal_$("manhattanPal-breakdown").innerHTML = `<div class="manhattanPal-bad">${spouse.reason}</div>`;
      manhattanPal_$("manhattanPal-total").textContent = "$0.00";
      document.getElementById("manhattanPal-output").style.display='none';
      return;
    }else{
      if(children==0){str="Individual + Spouse";}
      else if(children>0){str="Family";}
    }
  }else{
     if(children>0){str="Individual + Children";}
     else{str="Individual";}
  }
  if(window.activePlanKey==="hcs"){
     var children_additions=DATASET?.children_additions
     var tobacoKey= (pT)?"tob":"non";
     var stobacoKey= (sT)?"tob":"non";
     childTotal = children_additions?.[state.toUpperCase()]?.totals?.[children] ?? 0;
     var genderStateAgeTobTotal = DATASET?.[primaryGender.toLowerCase()]?.[state.toUpperCase()]?.[primaryAge]?.[tobacoKey] ?? 0;

     var spouse_genderStateAgeTobTotal = DATASET?.[spouseGender.toLowerCase()]?.[state.toUpperCase()]?.[sAge]?.[stobacoKey] ?? 0;

    console.log(childTotal,genderStateAgeTobTotal,spouse_genderStateAgeTobTotal)
     total= childTotal+genderStateAgeTobTotal+spouse_genderStateAgeTobTotal;
     manhattanPal_$("manhattanPal-total").innerHTML = manhattanPal_money(total)+" <span class='coverage_str' data-coverage='"+str+"'>("+str+")</span>";
  }else{
    childTotal = children * MANHATTAN_PAL_CHILD_ADD;
      total = primary.final + (spouse ? spouse.final : 0) + childTotal;
      manhattanPal_$("manhattanPal-total").innerHTML = manhattanPal_money(total)+" <span class='coverage_str' data-coverage='"+str+"'>("+str+")</span>";
  }
 
 

const lines = [];
lines.push(`
  <div style="margin-top: 15px;" class="price-card" data-price="${parseInt(total,10)}">
    <div class="label">${str}</div>
    <div class="value">$${parseInt(total,10)}</div>
    <div class="per-month">Per Month</div>
  </div>`);

const providerLink = (activePlan && activePlan.checkLink) ? activePlan.checkLink : '#';

lines.push(`
  <div class="summary" id="popup-summary">
    <p>No deductible, no copays, PPO network access.</p>
    <p class="instruction">Use your ZIP to search providers</p>
    <a class="btn-check" href="${providerLink}" target="_blank" rel="noopener">Check Participating Doctors</a>
  </div>

  <div class="view-benefits" style="display: block;">
    <a id="popup-benefits" href="${benefits_link}" target="_blank">View Summary of Benefits</a>
  </div>
`);
  manhattanPal_$("manhattanPal-breakdown").innerHTML = lines.join("");

  // Update Apply Now link with the calculated premium
  if (activePlan && activePlan.apply) {
    setApplyHrefWithPrice(activePlan.apply, total.toFixed(2));
    
    // Store selected plan info for email
    window.selectedPlanInfo = {
      planTitle: activePlan.title,
      price: total.toFixed(2),
      planKey: activePlanKey,
      coverageType:  document.querySelector('.coverage_str').dataset.coverage.trim() || 'Monthly Premium'
    };
    
    // Show Apply Now button
    const applyNowEl = document.querySelector('.apply-now');
    if (applyNowEl) {
      applyNowEl.style.display = 'block';
      document.getElementById("manhattanPal-output").style.display='block';
    }
  }
}

function manhattanPal_init(){
  var planKey=window.activePlanKey;
  if(planKey==="hcs"){
    manhattanPal_fillSelect(manhattanPal_$("manhattanPal-state"), activePlan.states.map(s=>({value:s,label:s})), "Choose State");
  }else{
    manhattanPal_fillSelect(manhattanPal_$("manhattanPal-state"), MANHATTAN_PAL_STATE_ABBRS.map(s=>({value:s,label:s})), "Choose State");
  }
  

  const ages = [];
  for (let a=21; a<=50; a++) ages.push(a);
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-primaryAge"), ages.map(a=>({value:a,label:a})), "Choose Age");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseAge"),  ages.map(a=>({value:a,label:a})), "Choose Age");

  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-primaryTobacco"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-primaryDiabetes"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseTobacco"),  [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseDiabetes"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");

  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-addSpouse"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");

  manhattanPal_fillSelect(manhattanPal_$("manhattanPal-childrenCount"), [
    {value:0, label:"No"},{value:1, label:"1"},{value:2, label:"2"},{value:3, label:"3"},
    {value:4, label:"4"},{value:5, label:"5"},{value:6, label:"6"}
  ], "Select");

  manhattanPal_hide("manhattanPal-primaryInputs");
  manhattanPal_hide("manhattanPal-primarySummary");
  manhattanPal_hide("manhattanPal-addSpouseField");
  manhattanPal_hide("manhattanPal-spouseChoiceSummary");
  manhattanPal_hide("manhattanPal-spouseInputs");
  manhattanPal_hide("manhattanPal-spouseSummary");
  manhattanPal_hide("manhattanPal-childrenField");
  manhattanPal_hide("manhattanPal-childrenSummary");

  manhattanPal_$("manhattanPal-primarySummaryText").textContent = "";
  manhattanPal_$("manhattanPal-spouseChoiceSummaryText").textContent = "";
  manhattanPal_$("manhattanPal-spouseSummaryText").textContent = "";
  manhattanPal_$("manhattanPal-childrenSummaryText").textContent = "";

  manhattanPal_enableViewBtn(false);
  manhattanPal_$("manhattanPal-breakdown").innerHTML = "";
  manhattanPal_$("manhattanPal-total").textContent = "$0.00";
  document.getElementById("manhattanPal-output").style.display='none';
}

function manhattanPal_resetAll(){ manhattanPal_init(); }

// Show/hide generic vs Manhattan calculator
function toggleCalculatorVisibility(planKey){
  const genericCalc = document.getElementById('generic-calculator');
  const manhattanCalc = document.getElementById('manhattanPal-calculator');
  
  if (planKey === 'manhattan' || planKey === 'hcs') {
    if (genericCalc) genericCalc.style.display = 'none';
    if (manhattanCalc) manhattanCalc.style.display = 'block';
    manhattanPal_init();
  } else {
    if (genericCalc) genericCalc.style.display = 'block';
    if (manhattanCalc) manhattanCalc.style.display = 'none';
  }
}

// --- Open plan popup
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.btn[data-plan]');
  if (!btn) return; // click was not on a plan button

  const planKey = btn.dataset.plan;
  if (!PLAN_DATA[planKey]) return;

  activePlanKey = planKey;
  window.activePlanKey = planKey;

  activePlan = PLAN_DATA[planKey];
  titleEl.textContent = activePlan.title;
  detailsEl.innerHTML = activePlan.details;

  // Cache-buster
  vbLink.href = addCacheBuster(activePlan.benefits);
  setApplyHref(activePlan.apply);

  // Toggle calculator
  toggleCalculatorVisibility(planKey);

  calcBtn.style.display = 'block';
  calcBtn.disabled = true;
  pricesEl.innerHTML = '';

  // Hide instruction text
  const instructionText = document.getElementById('price-instruction-text');
  if (instructionText) instructionText.style.display = 'none';

  // Medication search logic
  const medicationSearchSection = document.querySelector('.medication-search-section');
  if (medicationSearchSection) {
    medicationSearchSection.style.display =
      (planKey === 'manhattan' || planKey === 'hcs') ? 'none' : 'block';
  }

  summaryEl.innerHTML = '';
  document.querySelector('.view-benefits').style.display = 'none';
  document.querySelector('.apply-now').style.display = 'none';

  // Age select
  if (planKey !== 'manhattan') {
    populateSelect(ageSel, Object.keys(activePlan.prices), 'Choose Age');
  }

  // State select
  if (activePlan.states) {
    populateSelect(stateSel, activePlan.states, 'Choose State');
  } else {
    stateSel.innerHTML = `
      <option disabled selected value="">Choose State</option>
      <option>AK</option><option>AL</option><option>AR</option><option>AZ</option>
      <option>CO</option><option>DC</option><option>DE</option><option>FL</option>
      <option>GA</option><option>IA</option><option>ID</option><option>IL</option>
      <option>IN</option><option>KS</option><option>KY</option><option>LA</option>
      <option>MA</option><option>MD</option><option>ME</option><option>MI</option>
      <option>MO</option><option>MS</option><option>MT</option><option>NC</option>
      <option>ND</option><option>NE</option><option>NJ</option><option>NM</option>
      <option>NV</option><option>NY</option><option>OH</option><option>OK</option>
      <option>RI</option><option>SC</option><option>SD</option><option>TN</option>
      <option>TX</option><option>UT</option><option>VA</option><option>WV</option>
      <option>WY</option>
    `;
  }

  refreshAgeOptionsForManhattan();

  popup.classList.add('active');
  lockScroll(true);
});


// --- Calculate + show prices
calcBtn.addEventListener('click', () => {
  if (!ageSel.value || !stateSel.value || !activePlan) return;

  ageSel.disabled = true;
  stateSel.disabled = true;

  let vals;
  if (activePlanKey === 'manhattan' && stateSel.value === 'FL' && ageSel.dataset.rateMode === 'exact') {
    const ageNum = parseInt(ageSel.value, 10);
    vals = MANHATTAN_FL_RATES[ageNum];
  } else {
    vals = activePlan.prices[ageSel.value];
  }

  const labels = ['Individual', 'Individual + Spouse', 'Individual + Children', 'Family'];
  
  // Show instruction text above price grid
  const instructionText = document.getElementById('price-instruction-text');
  if (instructionText) {
    instructionText.style.display = 'block';
  }
  
  // Populate price grid (without the instruction text inside)
  pricesEl.innerHTML = (vals || []).map((v, i) => `
    <div class="price-card" data-price="${v}">
      <div class="label">${labels[i]}</div>
      <div class="value">$${v}</div>
      <div class="per-month">Per Month</div>
    </div>`).join('') || `
    <div class="price-card">
      <div class="label">No rate</div>
      <div class="value">—</div>
      <div class="per-month">Per Month</div>
    </div>`;

pricesEl.querySelectorAll('.price-card').forEach(card => {
card.addEventListener('click', () => {
  // Highlight the active price card
  pricesEl.querySelectorAll('.price-card').forEach(c => c.style.borderLeftColor = 'var(--accent1)');
  card.style.borderLeftColor = 'var(--secondary)';

  // Get selected price and update Apply Now link
  const selectedPrice = card.getAttribute('data-price');
  setApplyHrefWithPrice(activePlan.apply, selectedPrice);
  
  // Get coverage type from the card's label
  const labelElement = card.querySelector('.label');
  const coverageType = labelElement ? labelElement.textContent.trim() : '';
  
  // Store selected plan info for email
  window.selectedPlanInfo = {
    planTitle: activePlan.title,
    price: selectedPrice,
    planKey: activePlanKey,
    coverageType: coverageType  // e.g., "Individual", "Individual + Spouse", "Individual + Children", "Family"
  };
  
  // Show email modal
  showEmailModal();
});
});

  summaryEl.innerHTML = `
    <p>${activePlan.summaryText || ''}</p>
    <p class="instruction">${activePlan.checkInstruction || ''}</p>
    <button class="btn-check" id="check-doctors">Check Participating Doctors</button>`;

  const checkBtn = document.getElementById('check-doctors');
  if (checkBtn) checkBtn.onclick = () => window.open(activePlan.checkLink, '_blank');

  document.querySelector('.view-benefits').style.display = 'block';
  document.querySelector('.apply-now').style.display = 'block';
  calcBtn.style.display = 'none';
});

// --- Popup close
popupClose.addEventListener('click', () => {
  popup.classList.remove('active');
  resetPopup();
  lockScroll(isAnyOverlayOpen());
});
popup.addEventListener('click', e => {
  if (e.target === popup) {
    popup.classList.remove('active');
    resetPopup();
    lockScroll(isAnyOverlayOpen());
  }
});

// --- React to select changes
ageSel.addEventListener('change', updateCalcBtnState);
stateSel.addEventListener('change', () => {
  // Only touch ages when Manhattan is open and we (enter/leave) FL
  if (activePlanKey === 'manhattan' && (stateSel.value === 'FL' || ageSel.dataset.rateMode === 'exact')) {
    refreshAgeOptionsForManhattan();
  }
  updateCalcBtnState();
});

// --- Manhattan PAL Calculator Event Listeners
(function setupManhattanPALListeners() {
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupManhattanPALListeners);
    return;
  }
  
  // State change handler
  const stateEl = manhattanPal_$("manhattanPal-state");
  if (stateEl) {
    stateEl.addEventListener("change", ()=>{
      const ages = [];
      if(window.activePlanKey==="hcs"){for (let a=18; a<=64; a++) ages.push(a);
      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-primaryGender"), [{value:"male",label:"Male"},{value:"female",label:"Female"}], "Select");

      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseGender"), [{value:"male",label:"Male"},{value:"female",label:"Female"}], "Select");


    }
      else{for (let a=21; a<=50; a++) ages.push(a);}
      

      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-primaryAge"), ages.map(a=>({value:a,label:a})), "Choose Age");
      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-primaryTobacco"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-primaryDiabetes"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");

      manhattanPal_hide("manhattanPal-primarySummary");
      manhattanPal_$("manhattanPal-primarySummaryText").textContent = "";
      manhattanPal_show("manhattanPal-primaryInputs");

      // reset spouse + children chain
      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-addSpouse"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
      manhattanPal_hide("manhattanPal-addSpouseField");
      manhattanPal_hide("manhattanPal-spouseChoiceSummary");
      manhattanPal_$("manhattanPal-spouseChoiceSummaryText").textContent = "";

      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseAge"), ages.map(a=>({value:a,label:a})), "Choose Age");
      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseTobacco"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-spouseDiabetes"), [{value:"no",label:"No"},{value:"yes",label:"Yes"}], "Select");
      manhattanPal_hide("manhattanPal-spouseInputs");
      manhattanPal_hide("manhattanPal-spouseSummary");
      manhattanPal_$("manhattanPal-spouseSummaryText").textContent = "";

      manhattanPal_fillSelect(manhattanPal_$("manhattanPal-childrenCount"), [
        {value:0,label:"No"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},
        {value:4,label:"4"},{value:5,label:"5"},{value:6,label:"6"}
      ], "Select");
      manhattanPal_hide("manhattanPal-childrenField");
      manhattanPal_hide("manhattanPal-childrenSummary");
      manhattanPal_$("manhattanPal-childrenSummaryText").textContent = "";

      manhattanPal_enableViewBtn(false);
      manhattanPal_$("manhattanPal-breakdown").innerHTML = "";
      manhattanPal_$("manhattanPal-total").textContent = "$0.00";
      document.getElementById("manhattanPal-output").style.display='none';

      manhattanPal_flowUpdate();
    });
  }

  // Field change handlers
  ["manhattanPal-primaryAge","manhattanPal-primaryTobacco","manhattanPal-primaryDiabetes",
   "manhattanPal-addSpouse","manhattanPal-spouseAge","manhattanPal-spouseTobacco",
   "manhattanPal-spouseDiabetes","manhattanPal-childrenCount"].forEach(id=>{
    const el = manhattanPal_$(id);
    if (el) {
      el.addEventListener("change", ()=>{
        manhattanPal_$("manhattanPal-breakdown").innerHTML = "";
        manhattanPal_$("manhattanPal-total").textContent = "$0.00";
        document.getElementById("manhattanPal-output").style.display='none';
        manhattanPal_flowUpdate();
      });
    }
  });

  // Edit button handlers
  const editPrimaryBtn = manhattanPal_$("manhattanPal-editPrimaryBtn");
  if (editPrimaryBtn) editPrimaryBtn.addEventListener("click", manhattanPal_unlockPrimaryForEdit);
  
  const editSpouseChoiceBtn = manhattanPal_$("manhattanPal-editSpouseChoiceBtn");
  if (editSpouseChoiceBtn) editSpouseChoiceBtn.addEventListener("click", manhattanPal_unlockSpouseChoiceForEdit);
  
  const editSpouseBtn = manhattanPal_$("manhattanPal-editSpouseBtn");
  if (editSpouseBtn) editSpouseBtn.addEventListener("click", manhattanPal_unlockSpouseForEdit);
  
  const editChildrenBtn = manhattanPal_$("manhattanPal-editChildrenBtn");
  if (editChildrenBtn) editChildrenBtn.addEventListener("click", manhattanPal_unlockChildrenForEdit);

  // View Premiums button
  const viewBtn = manhattanPal_$("manhattanPal-viewBtn");
  if (viewBtn) viewBtn.addEventListener("click", manhattanPal_viewPremiums);

  // Initial flow update
  manhattanPal_flowUpdate();
})();

// --- Modal open/close (global)
window.openModal = function(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = 'block';
  lockScroll(true);
};
window.closeModal = function(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = 'none';
  lockScroll(isAnyOverlayOpen());
};
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', function (e) {
    if (e.target === modal) {
      modal.style.display = 'none';
      lockScroll(isAnyOverlayOpen());
    }
  });
});
});

function renderPlanButtons(plans = []) {
  return `
    <div class="hintPlansGrid">
      ${plans.map(p => `
        <button class="hintPlanBtn open-popup" type="button" data-plan="${p.key}">
          <span class="hintPlanTitle">${p.label}</span>
          ${p.sub ? `<span class="hintPlanSub">${p.sub}</span>` : ""}
        </button>
      `).join("")}
    </div>
  `;
}


// ===== 4) Deep-link handler (SAFE, runs after everything is ready) =====
(function setupDeepLinksOnceUIReady() {
// Run after DOMContentLoaded so window.openModal and popup code exist
window.addEventListener('DOMContentLoaded', () => {
  // Check if already handled by second handler
  if (window.__deepLinkHandled) return;
  
  const CONTACT_TO_MODAL = {
    lifex: 'modalLifeX',
    psm: 'modalIronHealth',
    gigcare: 'modalGigcare',
    manhattan: 'modalManhattan',
    hcs: 'modalHcs'
  };

  // Convert raw age → correct UI selector value per plan
  function bandForUrl(planKey, ageParamRaw, stateAb) {
    const raw = String(ageParamRaw || '').trim();
    if (!raw) return '';
    if (/^\d{2}\s*[–-]\s*\d{2}$/.test(raw)) {
      return raw.replace(/-/g,'–').replace(/\s+/g,'');
    }
    const n = parseInt(raw, 10);
    if (Number.isNaN(n)) return raw;
    const age = Math.min(Math.max(n, 18), 64);

    if (planKey === 'manhattan') {
      if (stateAb === 'FL') return String(age);
      if (age <= 29) return '18–29';
      if (age <= 39) return '30–39';
      if (age <= 49) return '40–49';
      return '50–64';
    }
    if (planKey === 'hcs') return '18–64';
    if (age >= 18 && age <= 29) return '18–29';
    if (age >= 30 && age <= 44) return '30–44';
    if (age >= 45 && age <= 54) return '45–54';
    if (age >= 55 && age <= 64) return '55–64';
    return '55–64'; // fallback
  }

  // Cheap readiness loop without capturing outer locals
  function waitForPopupReady(cb, tries = 60) {
    const popup = document.getElementById('plan-popup');
    const ageSel = document.getElementById('popup-age');
    const stateSel = document.getElementById('popup-state');
    if (popup && popup.classList.contains('active') && ageSel && stateSel) {
      cb({ popup, ageSel, stateSel });
      return;
    }
    if (tries <= 0) return;
    setTimeout(() => waitForPopupReady(cb, tries - 1), 50);
  }

  const qs = new URLSearchParams(location.search);

  // 1) ?contact=<lifex|psm|gigcare|manhattan>
  (function handleContactParam() {
    const contact = (qs.get('contact') || '').toLowerCase().trim();
    const modalId = CONTACT_TO_MODAL[contact];
    if (!modalId) return;
    if (typeof window.openModal === 'function') {
      window.openModal(modalId);
    } else {
      // ultra-defensive: open after a tick if helper isn’t set yet
      setTimeout(() => window.openModal && window.openModal(modalId), 0);
    }
  })();

  // 2) ?plan=&age=&state=&autocalc=1
  // DISABLED: Second handler (deepLinkFixer) handles this more robustly
  // Keeping this disabled to prevent conflicts and flickering
  (function handlePlanParam() {
    // Skip plan handling - let second handler do it
    // This prevents both handlers from running and causing flickering
    return;
    
    const planKey = (qs.get('plan') || '').toLowerCase().trim();
    if (!planKey) return;

    // Mark as handled EARLY to prevent second handler from running
    window.__deepLinkHandled = true;

    // Click the right "Get Price" button to initialize the popup flow
    const trigger = document.querySelector(`.btn[data-plan="${planKey}"]`);
    if (!trigger) return;
    trigger.click();

    waitForPopupReady(({ ageSel, stateSel }) => {
      
      const stateAb = (qs.get('state') || '').toUpperCase().trim();
      const ageRaw  = qs.get('age');

      // Select state first (so Manhattan can flip to FL exact ages)
      if (stateAb) {
        const hasState = Array.from(stateSel.options).some(o => o.value === stateAb);
        if (hasState) {
          stateSel.value = stateAb;
          stateSel.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }

      // If Manhattan + FL, ensure exact ages 18..64 are shown (idempotent)
      if (planKey === 'manhattan' && stateSel.value === 'FL') {
        const sel = document.getElementById('popup-age');
        if (sel && sel.dataset.rateMode !== 'exact') {
          sel.innerHTML =
            `<option disabled selected value="">Choose Age</option>` +
            Array.from({length:47}, (_,i)=>String(18+i))
                 .map(a=>`<option value="${a}">${a}</option>`).join('');
          sel.dataset.rateMode = 'exact';
        }
      }

      const ageUI = bandForUrl(planKey, ageRaw, stateSel.value);
      if (ageUI) {
        const hasAge = Array.from(ageSel.options).some(o => o.value === ageUI);
        if (hasAge) {
          ageSel.value = ageUI;
          ageSel.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }

      const auto = (qs.get('autocalc') || '').trim() === '1';
      const calcBtn = document.getElementById('popup-calc');
      if (auto && ageSel.value && stateSel.value && calcBtn && !calcBtn.disabled) {
        // Small delay to ensure values are set
        setTimeout(() => calcBtn.click(), 100);
      }
    });
  })();
});
})();

(function () {
const params   = new URLSearchParams(location.search);
const fromUrl  = (params.get('agent') || '').toLowerCase().replace(/\s+/g,'');
const stored   = sessionStorage.getItem('agentSlug') || '';
const agentSlug = fromUrl || stored || '';
if (agentSlug) sessionStorage.setItem('agentSlug', agentSlug);

// Load agents from Cloudinary (agents.v1.json)
// Minimal fallback MAP - only FHS as default if Cloudinary fails to load
let MAP = {
  /*FHS: { 
    name:'FHS', 
    email:'info@firsthealth-insurancesolutions.com', 
    code:'FHS', 
    phone:'',
    calendar: '',
    applications: {
      manhattan: 'https://firsthealth-insurancesolutions.com/optimum-app-1?agent=FHS',
      psm: 'https://firsthealth-insurancesolutions.com/maxguard-300-phq-1?agent=FHS',
      silver: 'https://firsthealth-insurancesolutions.com/phcs-250-phq-1?agent=FHS',
      seven: 'https://firsthealth-insurancesolutions.com/cigna-7250-phq-1?agent=FHS',
      iec: 'https://firsthealth-insurancesolutions.com/cigna-500-epo-phq-1?agent=FHS',
      hcs: 'https://firsthealth-insurancesolutions.com/uhc-5000-app?agent=FHS',
      five: 'https://firsthealth-insurancesolutions.com/psm-bcbs-7350-phq-1?agent=FHS',
      three: 'https://firsthealth-insurancesolutions.com/psm-bcbs-2500-phq-1?agent=FHS'
    }
  }*/
};

// Load agents from Cloudinary
window.agentsLoaded = false;
(async function loadAgentsFromCloudinary() {
  try {
    // Load agents from Cloudinary (single source of truth)
    // Add cache-buster to ensure fresh fetch from Cloudinary
    const response = await fetch(addCacheBuster(AGENTS_URL));
    if (response.ok) {
      const data = await response.json();
      if (data.agents) {
        // Convert agents object to MAP format (lowercase keys for matching)
        const newMap = {};
        Object.keys(data.agents).forEach(key => {
          const lowerKey = key.toLowerCase();
          newMap[lowerKey] = data.agents[key];
        });
        // Merge with existing MAP (keeps defaults if Cloudinary fails)
        MAP = Object.assign({}, MAP, newMap);
        // Update Agent._MAP reference
        if (window.Agent) window.Agent._MAP = MAP;
        window.agentsLoaded = true;
        console.log('Agents loaded from Cloudinary:', Object.keys(newMap));
        console.log(window.Agent._MAP)
      }
    }
  } catch (error) {
    console.warn('Could not load agents from Cloudinary, using default MAP:', error);
    // Falls back to default MAP defined above
  }
})();

// Function to ensure agents are loaded (for use before sending email)
window.ensureAgentsLoaded = async function() {
  if (window.agentsLoaded) return Promise.resolve();
  // If not loaded yet, try to load synchronously
  try {
    // Load agents from Cloudinary (single source of truth)
    // Add cache-buster to ensure fresh fetch from Cloudinary
    const response = await fetch(addCacheBuster(AGENTS_URL));
    if (response.ok) {
      const data = await response.json();
      if (data.agents) {
        const newMap = {};
        Object.keys(data.agents).forEach(key => {
          const lowerKey = key.toLowerCase();
          newMap[lowerKey] = data.agents[key];
        });
        MAP = Object.assign({}, MAP, newMap);
        if (window.Agent) window.Agent._MAP = MAP;
        window.agentsLoaded = true;
        console.log('Agents loaded synchronously from Cloudinary:', Object.keys(newMap));
      }
    }
  } catch (error) {
    console.warn('Could not load agents from Cloudinary:', error);
  }
};

function withParam(url) {
if (!agentSlug || !url) return url;
const u = new URL(url, location.origin);
u.searchParams.set('agent', agentSlug);
return u.toString();
}

window.Agent = {
slug: agentSlug,
exists: !!agentSlug,
_MAP: MAP,  // Expose MAP for debugging and direct access
getMeta(){ 
  const defaultMeta = { name: 'FHS', email: 'info@andersonhealthgroup.com', code: 'FHS', phone: '', calendar: '', applications: {} };
  if (!agentSlug) return MAP['FHS'] || MAP['fhs'] || defaultMeta;
  const lowerSlug = agentSlug.toLowerCase();
  return MAP[lowerSlug] || MAP[agentSlug] || MAP['FHS'] || MAP['fhs'] || defaultMeta;
},
withParam,                          // add ?agent=...
withEmailParams(payload){           // for EmailJS later
  const m = this.getMeta();
  return Object.assign({}, payload, {
    agent: agentSlug || 'FHS', 
    agent_slug: agentSlug || 'FHS',
    agent_name: m.name || 'FHS', 
    agent_code: m.code || 'FHS',
    agent_email: m.email || 'info@andersonhealthgroup.com',
    agent_phone: m.phone || '', 
    to_email: m.email || 'info@andersonhealthgroup.com'  // Send to agent's email
  });
}
};

// ✅ INSERT the full “Agent propagation hardening” block *right here* 👇


// ---------- Agent propagation hardening ----------
// ---------- Agent propagation hardening ----------
function stampUrl(url){
try {
  if (!Agent || !Agent.exists || !url) return url;
  const u = new URL(url, location.origin);
  if (!u.searchParams.get('agent')) u.searchParams.set('agent', Agent.slug);
  return u.toString();
} catch {
  return url;
}
}

// Add ?agent= to all anchor hrefs
function decorateAnchors(root=document){
root.querySelectorAll('a[href]').forEach(a=>{
  const href=a.getAttribute('href');
  if(!href||href.startsWith('#')||href.startsWith('mailto:')||href.startsWith('tel:'))return;
  a.href=stampUrl(a.href);
});
}

// Add ?agent= to all form actions
function decorateForms(root=document){
root.querySelectorAll('form').forEach(form=>{
  // Ensure a hidden agent field is present (works for POST or GET)
  let hidden = form.querySelector('input[name="agent"][type="hidden"]');
  if (!hidden){
    hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = 'agent';
    form.appendChild(hidden);
  }
  hidden.value = (Agent && Agent.slug) ? Agent.slug : (hidden.value || '');

  // Resolve current action (empty -> current URL)
  const currentAction = form.getAttribute('action') || location.href;

  // Stamp the action once right now (covers GET method = querystring)
  form.setAttribute('action', stampUrl(currentAction));

  // On submit, belt-and-suspenders: refresh hidden value and restamp action
  form.addEventListener('submit', ()=>{
    if (Agent && Agent.slug) hidden.value = Agent.slug;

    // Important: restamp again in case any script re-wrote action
    const actNow = form.getAttribute('action') || location.href;
    form.setAttribute('action', stampUrl(actNow));

    // If method="get", the stamped action ensures ?agent=... appears in the final URL.
    // If method="post", the hidden input carries agent in the body.
  }, { once:false });
});
}

// Patch window.open to always include agent
(function patchNavigations(){
const origOpen=window.open;
window.open=function(u, n, f){
  try{
    u=stampUrl(u);
  }catch{}
  return origOpen.call(window, u, n, f);
};
})();

// Auto-decorate dynamically added links/forms
const mo=new MutationObserver(muts=>{
muts.forEach(m=>{
  m.addedNodes.forEach(n=>{
    if(n.nodeType!==1)return;
    if(n.matches('a[href]'))decorateAnchors(n.parentNode||document);
    if(n.matches('form[action]'))decorateForms(n.parentNode||document);
    if(n.querySelectorAll){
      decorateAnchors(n);
      decorateForms(n);
    }
  });
});
});
mo.observe(document.documentElement,{childList:true,subtree:true});

// Initial decorate on load
if(Agent&&Agent.exists){
decorateAnchors(document);
decorateForms(document);
}

// ✅ END of inserted block

})();
(function deepLinkFixer(){
// --- helpers --------------------------------------------------------------
function getParam(name){
  const v = new URLSearchParams(location.search).get(name);
  return v && v.trim() ? v.trim() : null;
}
function waitFor(selector, {tries=50, delay=120} = {}){
  return new Promise((resolve, reject) => {
    let n = 0;
    const tick = () => {
      const el = document.querySelector(selector);
      if (el) return resolve(el);
      if (++n >= tries) return reject(new Error('Not found: ' + selector));
      setTimeout(tick, delay);
    };
    tick();
  });
}
function clickIfExists(el){ if (el) el.click(); }
function safeSetValue(el, value){
  if (!el) return;
  const old = el.value;
  el.value = String(value);
  // fire change for any listeners
  if (old !== el.value) el.dispatchEvent(new Event('change', {bubbles:true}));
}
function openModalById(id){
  const m = document.getElementById(id);
  if (!m) return false;
  // your modals use either .active or style.display='block'
  if (m.classList.contains('popup')) m.classList.add('active');
  m.style.display = 'block';
  document.body.classList.add('modal-open');
  return true;
}

// --- map contact slugs -> modal IDs (edit if your IDs differ) -------------
const CONTACT_MAP = {
  lifex:   'modalLifeX',
  psm:     'modalIronHealth',       // Iron Health (PSM)
  gigcare: 'modalGigcare',   // BCBS NE / Gigcare
  manhattan: 'modalManhattan',
   hcs: 'modalHcs'
};

// Convert raw age → correct UI selector value per plan
function bandForUrl(planKey, ageParamRaw, stateAb) {
  const raw = String(ageParamRaw || '').trim();
  if (!raw) return '';
  if (/^\d{2}\s*[–-]\s*\d{2}$/.test(raw)) {
    return raw.replace(/-/g,'–').replace(/\s+/g,'');
  }
  const n = parseInt(raw, 10);
  if (Number.isNaN(n)) return raw;
  const age = Math.min(Math.max(n, 18), 64);

  if (planKey === 'manhattan') {
    if (stateAb === 'FL') return String(age);
    if (age <= 29) return '18–29';
    if (age <= 39) return '30–39';
    if (age <= 49) return '40–49';
    return '50–64';
  }
  if (planKey === 'hcs') return '18–64';
  if (age >= 18 && age <= 29) return '18–29';
  if (age >= 30 && age <= 44) return '30–44';
  if (age >= 45 && age <= 54) return '45–54';
  if (age >= 55 && age <= 64) return '55–64';
  return '55–64'; // fallback
}

// --- run once DOM is ready -----------------------------------------------
const onReady = async () => {
  // Check if deep link was already handled by the first handler
  if (window.__deepLinkHandled) return;
  
  const contact = (getParam('contact') || '').toLowerCase();
  const plan    = (getParam('plan')    || '').toLowerCase();
  const age     = getParam('age');
  const state   = getParam('state');
  const autocalc= (getParam('autocalc') || '').toLowerCase();
  const doAuto  = autocalc === '1' || autocalc === 'true';
  
  // If no plan param and no contact, skip
  if (!plan && !contact) return;
  
  // Mark as handling to prevent first handler from interfering
  window.__deepLinkHandled = true;

  // 1) CONTACT=... → open the corresponding carrier/resources modal
  if (contact) {
    // Try a direct modal open if ID is known
    if (CONTACT_MAP[contact] && openModalById(CONTACT_MAP[contact])) {
      // done
    } else {
      // Fallback: click any visible trigger button for this contact
      // Common patterns: [data-contact="psm"], [data-open="psm"], #open-psm
      const selector = [
        `[data-contact="${contact}"]`,
        `[data-open="${contact}"]`,
        `#open-${contact}`,
        `.open-${contact}`
      ].join(',');
      try {
        const trigger = await waitFor(selector);
        clickIfExists(trigger);
      } catch(e) {
        // As a last resort, open a generic modal if present
        openModalById(`modal-${contact}`);
      }
    }
  }

  // 2) PLAN=... → open pricing popup, set state/age, optionally autocalc
  if (plan) {
    // Best-effort: click the plan's "Get Price" button in its card
    // Try common structures: a dedicated button inside the card with data-plan
    const planCardSel = [
      `.btn[data-plan="${plan}"]`,
      `[data-plan="${plan}"] [data-open="price"]`,
      `[data-plan="${plan}"] .get-price`,
      `[data-plan="${plan}"] .btn-get-price`,
      `[data-plan="${plan}"] button`,
      `[data-plan="${plan}"] a`
    ].join(', ');
    try {
      const planOpenBtn = await waitFor(planCardSel);
      
      // Store values we want to set BEFORE clicking (since click will reset dropdowns)
      const stateToSet = state ? state.toUpperCase() : null;
      const ageToSet = age ? age : null;
      
      clickIfExists(planOpenBtn);
      // Give the click handler time to populate dropdowns and reset them
      await new Promise(resolve => setTimeout(resolve, 300));
    } catch {
      // If no button is found, try a global helper (if your code exposes one)
      // e.g., window.openPlanPopup && window.openPlanPopup(plan);
      try { if (window.openPlanPopup) window.openPlanPopup(plan); } catch {}
    }

    // Wait for the shared pricing popup to become active
    try {
      const popup = await waitFor('#plan-popup');
      // Wait for popup to be active (not just exist)
      let tries = 30;
      while (tries > 0 && !popup.classList.contains('active')) {
        await new Promise(resolve => setTimeout(resolve, 50));
        tries--;
      }
      
      // ensure visible if your system relies on .active
      if (!popup.classList.contains('active')) popup.classList.add('active');
      document.body.classList.add('modal-open');

      // Wait for dropdowns to be populated (after button click populates them)
      const selAge = popup.querySelector('#popup-age');
      const selState = popup.querySelector('#popup-state');
      
      // Wait for age dropdown to have multiple options (not just placeholder)
      if (selAge) {
        tries = 40;
        while (tries > 0 && selAge.options.length <= 1) {
          await new Promise(resolve => setTimeout(resolve, 50));
          tries--;
        }
      }
      
      // Wait for state dropdown to have options
      if (selState) {
        tries = 40;
        while (tries > 0 && selState.options.length <= 1) {
          await new Promise(resolve => setTimeout(resolve, 50));
          tries--;
        }
      }
      
      // Additional wait to ensure button handler has fully completed
      await new Promise(resolve => setTimeout(resolve, 100));

      // Get values from URL params (button click handler resets dropdowns, so we always need to set)
      const stateToSet = state ? state.toUpperCase() : null;
      const ageToSet = age ? age : null;
      
      // Check current values
      const currentStateValue = selState ? selState.value : '';
      const currentAgeValue = selAge ? selAge.value : '';
      const expectedState = stateToSet || '';
      const expectedAgeUI = ageToSet ? bandForUrl(plan, ageToSet, expectedState) : '';
      
      // Always set if we have URL params (button handler resets them)
      const needsStateSet = stateToSet && currentStateValue !== expectedState;
      const needsAgeSet = ageToSet && currentAgeValue !== expectedAgeUI && currentAgeValue !== ageToSet;

      // Set State first (important for Manhattan FL age swap)
      if (needsStateSet && selState && stateToSet) {
        const stateOptions = Array.from(selState.options).map(o => o.value);
        if (stateOptions.includes(stateToSet)) {
          selState.value = stateToSet;
          selState.dispatchEvent(new Event('change', { bubbles: true }));
          // Wait a bit for state change to propagate (especially for Manhattan FL)
          await new Promise(resolve => setTimeout(resolve, 250));
          
          // Re-check age dropdown in case Manhattan FL changed it
          if (plan === 'manhattan' && stateToSet === 'FL' && selAge) {
            tries = 40;
            while (tries > 0 && selAge.options.length <= 1) {
              await new Promise(resolve => setTimeout(resolve, 50));
              tries--;
            }
          }
        }
      }

      // Convert age to appropriate format (band or exact) based on plan and state
      if (needsAgeSet && selAge && ageToSet) {
        const currentState = selState ? selState.value : (stateToSet || '');
        const ageUI = bandForUrl(plan, ageToSet, currentState);
        
        console.log('Setting age:', { ageToSet, ageUI, currentState, plan });
        
        // Check if the converted age value exists in the dropdown
        if (ageUI) {
          const ageOptions = Array.from(selAge.options).map(o => o.value);
          console.log('Available age options:', ageOptions);
          
          // Normalize both the ageUI and options for comparison (handle en-dash vs hyphen)
          const normalizedAgeUI = ageUI.replace(/[–-]/g, '-'); // Normalize to regular hyphen
          const normalizedOptions = ageOptions.map(opt => opt.replace(/[–-]/g, '-'));
          
          // Find matching option (case-insensitive and dash-normalized)
          const matchingOption = ageOptions.find((opt, idx) => {
            const normalizedOpt = normalizedOptions[idx];
            return normalizedOpt === normalizedAgeUI || opt === ageUI;
          });
          
          if (matchingOption !== undefined) {
            selAge.value = matchingOption; // Use the actual option value (preserves original dash type)
            selAge.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('Age set successfully to:', matchingOption);
          } else {
            // Fallback: try setting the raw age if conversion didn't work
            const rawAgeOptions = Array.from(selAge.options).map(o => o.value);
            console.log('Age UI not found, trying raw age. Raw options:', rawAgeOptions);
            if (rawAgeOptions.includes(ageToSet)) {
              selAge.value = ageToSet;
              selAge.dispatchEvent(new Event('change', { bubbles: true }));
              console.log('Raw age set successfully to:', ageToSet);
            } else {
              console.warn('Could not set age. Age UI:', ageUI, 'Normalized:', normalizedAgeUI, 'Raw age:', ageToSet, 'Available:', ageOptions, 'Normalized options:', normalizedOptions);
            }
          }
        } else {
          console.warn('bandForUrl returned empty for:', { plan, ageToSet, currentState });
        }
      }
      
      // Final wait to ensure button handler has fully completed and all DOM updates are done
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Re-check dropdowns after wait (they might have been reset)
      const finalSelAge = popup.querySelector('#popup-age');
      const finalSelState = popup.querySelector('#popup-state');
      
      // If values were reset, set them again
      if (stateToSet && finalSelState && finalSelState.value !== stateToSet) {
        const stateOptions = Array.from(finalSelState.options).map(o => o.value);
        if (stateOptions.includes(stateToSet)) {
          finalSelState.value = stateToSet;
          finalSelState.dispatchEvent(new Event('change', { bubbles: true }));
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
      
      if (ageToSet && finalSelAge) {
        const currentStateForAge = finalSelState ? finalSelState.value : (stateToSet || '');
        const ageUI = bandForUrl(plan, ageToSet, currentStateForAge);
        const currentAgeVal = finalSelAge.value;
        
        console.log('Final age check:', { ageToSet, ageUI, currentAgeVal, currentStateForAge });
        
        if (ageUI && currentAgeVal !== ageUI && currentAgeVal !== ageToSet) {
          const ageOptions = Array.from(finalSelAge.options).map(o => o.value);
          console.log('Final age options:', ageOptions);
          
          // Normalize both the ageUI and options for comparison (handle en-dash vs hyphen)
          const normalizedAgeUI = ageUI.replace(/[–-]/g, '-'); // Normalize to regular hyphen
          const normalizedOptions = ageOptions.map(opt => opt.replace(/[–-]/g, '-'));
          
          // Find matching option (case-insensitive and dash-normalized)
          const matchingOption = ageOptions.find((opt, idx) => {
            const normalizedOpt = normalizedOptions[idx];
            return normalizedOpt === normalizedAgeUI || opt === ageUI;
          });
          
          if (matchingOption !== undefined) {
            finalSelAge.value = matchingOption; // Use the actual option value (preserves original dash type)
            finalSelAge.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('Final age set to:', matchingOption);
          } else if (ageOptions.includes(ageToSet)) {
            finalSelAge.value = ageToSet;
            finalSelAge.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('Final age set to raw:', ageToSet);
          } else {
            console.warn('Final: Could not set age. UI:', ageUI, 'Normalized:', normalizedAgeUI, 'Raw:', ageToSet, 'Options:', ageOptions, 'Normalized options:', normalizedOptions);
          }
        } else if (!ageUI) {
          console.warn('Final: bandForUrl returned empty for:', { plan, ageToSet, currentStateForAge });
        }
      }

      // Autocalculate if requested
      if (doAuto) {
        const calcBtn = popup.querySelector('#popup-calc');
        if (calcBtn && !calcBtn.disabled) {
          // Small delay to ensure values are set
          await new Promise(resolve => setTimeout(resolve, 150));
          calcBtn.click();
        }
      }

      // Defense-in-depth: if your title needs to reflect the plan, try to match
      const titleEl = popup.querySelector('#popup-title');
      if (titleEl && typeof plan === 'string' && titleEl.textContent.trim() === '') {
        // Light touch — only set if empty
        titleEl.textContent = plan.toUpperCase();
      }
      
      // Mark as handled
      window.__deepLinkHandled = true;
    } catch(e) {
      // popup didn't appear—nothing else to do quietly
      console.warn('Deep link handler error:', e);
    }
  }
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', onReady, { once:true });
} else {
  onReady();
}
})();

// ===== 5) EmailJS Integration =====
/*
* EMAILJS CONFIGURATION INSTRUCTIONS:
* 
* 1. Sign up at https://www.emailjs.com/
* 2. Create an Email Service (Gmail, Outlook, etc.)
* 3. Create an Email Template with variables: {{to_email}}, {{plan_title}}, {{plan_price}}, {{plan_key}}, {{user_email}}
* 4. Get your Public Key from Account > API Keys
* 5. Update the following in this code:
*    - Line ~2771: Uncomment and add: emailjs.init("YOUR_PUBLIC_KEY");
*    - Line ~2776: Replace 'YOUR_SERVICE_ID' with your service ID
*    - Line ~2777: Replace 'YOUR_TEMPLATE_ID' with your template ID
* 
* The email will be sent when a user clicks a price card and submits their email.
*/
(function setupEmailJS() {
// Initialize EmailJS (user will configure their service ID, template ID, and public key)
// Note: User needs to set these values in EmailJS dashboard
let emailjsInitialized = false;

function toProperCase(str = "") {
  let s = str.trim().toLowerCase();

  // Capitalize first letter after spaces, apostrophes, and hyphens
  s = s.replace(/(^|[\s'-])[a-z]/g, m => m.toUpperCase());

  // Fix common Mc/Mac patterns (basic)
  s = s.replace(/\bMc([a-z])/g, (_, c) => "Mc" + c.toUpperCase());
  s = s.replace(/\bMac([a-z])/g, (_, c) => "Mac" + c.toUpperCase());

  return s;
}
// ===== EMAIL TEMPLATE CONFIGURATION =====
// 
// Template mapping: Each plan has 1 template (pricing is handled via fieldname {{plan_price}})
// Note: Age bands are no longer needed since pricing is dynamic via fieldname
//
// EMAILJS TEMPLATE VARIABLES AVAILABLE:
// - {{to_email}} - Agent email address
// - {{agent_email}} - Agent email
// - {{agent_name}} - Agent name
// - {{agent_code}} - Agent code
// - {{agent_phone}} - Agent phone number
// - {{agent_slug}} - Agent slug identifier
// - {{agent_calendar}} - Agent calendar booking URL (from agents.v1.json)
// - {{application_link}} - Application URL for selected plan (from agents.v1.json, plan-specific)
// - {{name}} - User's name (use "Hi {{name}}," in email templates)
// - {{user_email}} - User's email address
// - {{plan_title}} - Plan title (e.g., "LifeX 7250 Deductible")
// - {{plan_price}} - Selected plan price (dynamic, handles all age ranges)
// - {{plan_key}} - Plan key (e.g., "seven", "five", "three")
// - {{coverage_type}} - Selected coverage type (e.g., "Individual", "Individual + Spouse", "Individual + Children", "Family")
// - {{pdf_attachment_url}} - PDF attachment URL (use in EmailJS template settings)
// - {{attachment_url}} - Alternative PDF attachment URL variable
//

// Map plan to single template ID (one template per plan)
const PLAN_TEMPLATES = {
  // Affordable Choice Elite (manhattan)
  manhattan: 'template_8dl59td',
  // UHC Premier 5000 (hcs)
  hcs: 'template_q0bbb3r',
  // GIGCARE 2500 DEDUCTIBLE (three)
  three: 'template_5hzubnm',
  // GIGCARE 7350 DEDUCTIBLE (five)
  five: 'template_a5qcats',
  // LifeX VL 500 Deductible (silver)
  silver: 'template_abg0tzs',
  // LifeX MM 500 Deductible (iec)
  iec: 'template_yy4c8sq',
  // LifeX 7250 Deductible (seven)
  seven: 'template_cynerxk',
  // Maxguard 300 Deductible (psm)
  psm: 'template_km65fsm'
};

// Function to get template ID and PDF based on plan key
// Note: PDF attachments use PLAN_DATA[plan].benefits (same as view benefits link)
// Age band parameter is no longer used since pricing is handled via {{plan_price}} fieldname
function getTemplateConfig(planKey, ageBand) {
  const plan = planKey?.toLowerCase();
  const templateId = PLAN_TEMPLATES[plan];
    var stateIDValue =getStateSelect().value;
    if(!stateIDValue){
      stateIDValue=document.querySelector("#popup-state").value;
    }
    var pdfUrlLicense =
        window.FHS_STATE_LICENSE_PDFS?.[stateIDValue] ?? '';
    console.log(pdfUrlLicense);
  // Use PLAN_DATA.benefits as single source of truth for email attachments (same as view benefits)
  // Add cache-buster to ensure fresh PDF fetch from Cloudinary
  const pdfUrl = addCacheBuster(PLAN_DATA[plan]?.benefits || '');
  if (!templateId) {
    console.warn(`No template found for plan: ${planKey}`);
    return { templateId: '', pdfAttachment: pdfUrl, pdfAttachmentLicense: pdfUrlLicense,state:stateIDValue };
  }
  
  return {
    templateId: templateId,
    pdfAttachment: pdfUrl,
    pdfAttachmentLicense: pdfUrlLicense,
    state:stateIDValue
  };
}

function initEmailJS() {
  if (emailjsInitialized || typeof emailjs === 'undefined') return;
  try {
    // Initialize EmailJS with public key
    emailjs.init("QyMbnW-B_ir0T7FT1");
    emailjsInitialized = true;
  } catch (e) {
    console.error('EmailJS initialization error:', e);
  }
}

// Show email modal
window.showEmailModal = function() {
  const modal = document.getElementById('email-modal');
  if (!modal) return;
  modal.style.display = 'block';
  // Use existing lockScroll if available, otherwise use body class
  if (typeof lockScroll === 'function') {
    lockScroll(true);
  } else {
    document.body.classList.add('modal-open');
  }
  const nameInput = document.getElementById('name-input');
  if (nameInput) nameInput.focus();
};

// Hide email modal
function hideEmailModal() {
  const modal = document.getElementById('email-modal');
  if (!modal) return;
  modal.style.display = 'none';
  const emailForm = document.getElementById('email-form');
  const emailStatus = document.getElementById('email-status');
  if (emailForm) emailForm.reset();
  if (emailStatus) emailStatus.style.display = 'none';
  // Use existing lockScroll if available
  if (typeof lockScroll === 'function') {
    lockScroll(typeof isAnyOverlayOpen === 'function' ? isAnyOverlayOpen() : false);
  } else {
    document.body.classList.remove('modal-open');
  }
}

// Email modal event listeners
document.addEventListener('DOMContentLoaded', () => {
  const emailModal = document.getElementById('email-modal');
  const emailForm = document.getElementById('email-form');
  const emailInput = document.getElementById('email-input');
  const emailSendBtn = document.getElementById('email-send-btn');
  const emailCancelBtn = document.getElementById('email-cancel-btn');
  const emailModalClose = document.getElementById('email-modal-close');
  const emailStatus = document.getElementById('email-status');
  
  if (!emailModal || !emailForm) return;
  
  // Close modal handlers
  if (emailModalClose) {
    emailModalClose.addEventListener('click', hideEmailModal);
  }
  if (emailCancelBtn) {
    emailCancelBtn.addEventListener('click', hideEmailModal);
  }
  emailModal.addEventListener('click', (e) => {
    if (e.target === emailModal) hideEmailModal();
  });
  
  // Form submission
  emailForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
   const nameInput = document.getElementById('name-input');
  const rawName = nameInput ? nameInput.value : '';
  const name = toProperCase(rawName);
    const email = emailInput.value.trim();
    
    if (!name) {
      showEmailStatus('Please enter your name.', 'error');
      return;
    }
    if (!email) {
      showEmailStatus('Please enter a valid email address.', 'error');
      return;
    }
    
    // Disable send button during submission
    emailSendBtn.disabled = true;
    emailSendBtn.textContent = 'Sending...';
    showEmailStatus('Sending email...', 'info');
    
    try {
      initEmailJS();
      
      // Ensure agents are loaded from Cloudinary before proceeding
      if (window.ensureAgentsLoaded) {
        await window.ensureAgentsLoaded();
      }
      
      // Get plan info
      const planInfo = window.selectedPlanInfo || {};
      
      // Get age band from the age select element
      const ageSel = document.getElementById('popup-age');
      const ageBand = ageSel ? ageSel.value : '';
      
      // Get agent info - ensure we have the correct agent email, phone, calendar, and application URL
      let agentEmail = 'Info@firsthealth-insurancesolutions.com';
      let agentName = 'FHS';
      let agentCode = 'FHS';
      let agentPhone = '';
      let agentCalendar = '';
      let agentApplication = '';
      let agentSlug = '';
      
      // Get plan key for application URL lookup
      const planKey = planInfo.planKey || '';
      let paramsUrl = Object.fromEntries(new URLSearchParams(window.location.search));

      if (window.Agent) {
        agentSlug = window.Agent.slug ||paramsUrl.agent ||'';
        
        // Refresh MAP reference to ensure we have latest data
        const currentMap = window.Agent._MAP || {};
        
        // Determine which agent to use (slug or fallback to FHS)
        const agentKey = agentSlug ? agentSlug.toLowerCase() : 'fhs';
        const agentData = currentMap[agentKey] || currentMap['fhs'] || currentMap['FHS'];
        
        if (agentData) {
          agentEmail = agentData.email || agentEmail;
          agentName = agentData.name || agentName;
          agentCode = agentData.code || agentCode;
          agentPhone = agentData.phone || '';
          // Only use calendar if it's not empty
          if (agentData.calendar) {
            agentCalendar = agentData.calendar;
          }
          
          // Get application URL based on selected plan
          if (agentData.applications && planKey && agentData.applications[planKey]) {
            agentApplication = agentData.applications[planKey];
          }
        }
        
        // Also try getMeta() as a fallback (should return same data, but ensures consistency)
        const agentMeta = window.Agent.getMeta ? window.Agent.getMeta() : null;
        if (agentMeta) {
          // Use getMeta values if they're more complete
          if (agentMeta.email && agentMeta.email !== 'info@andersonhealthgroup.com') {
            agentEmail = agentMeta.email;
          }
          if (agentMeta.name && agentMeta.name !== 'FHS') {
            agentName = agentMeta.name;
          }
          if (agentMeta.code && agentMeta.code !== 'FHS') {
            agentCode = agentMeta.code;
          }
          if (agentMeta.phone) {
            agentPhone = agentMeta.phone;
          }
          // Only use calendar if it's not empty (prioritize non-empty values)
          if (agentMeta.calendar && agentMeta.calendar.trim()) {
            agentCalendar = agentMeta.calendar;
          }
          // Get application URL from meta if available
          if (agentMeta.applications && planKey && agentMeta.applications[planKey]) {
            agentApplication = agentMeta.applications[planKey];
          }
        }
      }
      var stateIDValue =getStateSelect().value;
      if(!stateIDValue){
        stateIDValue=document.querySelector("#popup-state").value;
      }
      
      // Debug logging
      const debugAgentKey = agentSlug ? agentSlug.toLowerCase() : 'fhs';
      const debugAgentData = window.Agent?._MAP?.[debugAgentKey];
      console.log('EmailJS Debug:', {
        agentSlug: agentSlug,
        agentKey: debugAgentKey,
        agentEmail: agentEmail,
        agentName: agentName,
        agentPhone: agentPhone,
        agentCalendar: agentCalendar,
        agentApplication: agentApplication,
        userEmail: email,
        planKey: planInfo.planKey,
        ageBand: ageBand,
        agentDataFromMap: debugAgentData,
        agentDataCalendar: debugAgentData?.calendar,
        agentDataApplications: debugAgentData?.applications,
        currentMapKeys: Object.keys(window.Agent?._MAP || {}),
        agentsLoaded: window.agentsLoaded
      });
      
      // EmailJS service parameters - email goes to agent, with user email for reference
      const templateParams = {
        to_email: agentEmail,  // Send to agent's email
        agent_email: agentEmail,
        agent_name: agentName,
        agent_code: agentCode,
        agent_phone: agentPhone,
        agent_slug: agentSlug,
        agent_calendar: agentCalendar || '',  // Agent calendar booking URL
        application_link: agentApplication || '',  // Application URL for selected plan
        name: name,  // User's name (use "Hi {{name}}," in email templates)
        user_email: email,  // User's email for reference
        plan_title: planInfo.planTitle || 'Health Plan',
        plan_price: parseInt(planInfo.price,10) || 'N/A',
        plan_key: planInfo.planKey || '',
        state:stateIDValue,
        coverage_type: planInfo.coverageType || ''  // e.g., "Individual", "Individual + Spouse", etc.
      };
      console.log(templateParams)

      // Send email via EmailJS
      // NOTE: Template is selected based on plan key only (one template per plan)
      // - serviceId: service_mj0qps3
      // - templateId: Selected dynamically based on plan key (age band no longer needed)
      // - publicKey: QyMbnW-B_ir0T7FT1 (via emailjs.init)
      // - PDF attachments: Uses PLAN_DATA[plan].benefits (same as view benefits link)
      
      if (typeof emailjs !== 'undefined' && emailjs.send) {
        // Initialize if not already done
        if (!emailjsInitialized) {
          emailjs.init("QyMbnW-B_ir0T7FT1");
        }
        
        // Get template configuration based on plan key (age band parameter kept for compatibility but not used)
        const planKey = planInfo.planKey || '';
        const templateConfig = getTemplateConfig(planKey, ageBand);
        
        // Add PDF attachment URL to template params
        // Note: Configure your EmailJS template to use {{pdf_attachment_url}} variable
        // In EmailJS template, you can add attachment using: {{pdf_attachment_url}}
        const emailParams = {
          ...templateParams,
          // PDF attachment URL - configure your EmailJS template to use this variable
          pdf_attachment_url: templateConfig.pdfAttachment || '',
          attachment_url: templateConfig.pdfAttachment || '',  // Alternative variable name
          license_attachment_url:templateConfig.pdfAttachmentLicense || '',  //  license variable name
          reply_to: email  // Reply-to should be user's email
        };

        console.log('EmailJS parameters:', emailParams);
        
        // Send email via EmailJS with selected template
        await emailjs.send(
          'service_mj0qps3',  // EmailJS Service ID
          templateConfig.templateId,  // Selected template ID based on plan key (one template per plan)
          emailParams
        );
        
// Send contact to GHL (Go High Level) for future drip campaigns

try {
  const GHL_WEBHOOK_URL =
    "https://services.leadconnectorhq.com/hooks/Z1YTMnrDzpEOXYq3OEos/webhook-trigger/3dc26b44-3e4c-46b4-99e1-8c0f2f39f718";


  if (!GHL_WEBHOOK_URL) {
    console.warn("❌ No GHL_WEBHOOK_URL set");
  } else {
    if (typeof resolveAgentFromUrl !== "function") {
      console.error("❌ resolveAgentFromUrl is not defined (function missing)");
    } else {
      await resolveAgentFromUrl();
    }

    const agent = window.ACTIVE_AGENT || {};

    const payload = {
      name: name,
      email: email,
      source: "Plan Inquiry",
      plan_title: planInfo?.planTitle || "",
      plan_key: planInfo?.planKey || "",
      coverage_type: planInfo?.coverageType || "",
      start_date: "2026-01-01",
      coverage_start_date: "2026-01-01",

      "contact.plan_price": (
        planInfo?.planPrice ??
        planInfo?.price ??
        window.activePlanPrice ??
        ""
      ).toString(),

      "contact.agent_slug": (window.AGENT_SLUG || "").toString(),
      "contact.agent_name": (agent.name || "").toString(),
      "contact.agent_email": (agent.email || "").toString(),
      "contact.agent_phone": (agent.phone || "").toString(),
    };

    console.table(payload);

    const resp = await fetch(GHL_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

  }
} catch (err) {
  console.error("❌ GHL contact creation error:", err);
}
        
        showEmailStatus('Email sent successfully!', 'success');
        setTimeout(() => {
          hideEmailModal();
        }, 2000);
      } else {
        // Fallback: show success message (for testing without EmailJS configured)
        console.log('EmailJS not configured. Template params:', templateParams);
        showEmailStatus('Email functionality ready. Configure EmailJS credentials to enable sending.', 'info');
        setTimeout(() => {
          hideEmailModal();
        }, 3000);
      }
    } catch (error) {
      console.error('Email send error:', error);
      showEmailStatus('Failed to send email. Please try again later.', 'error');
    } finally {
      emailSendBtn.disabled = false;
      emailSendBtn.textContent = 'Send';
    }
  });
  
  function showEmailStatus(message, type) {
    emailStatus.textContent = message;
    emailStatus.style.display = 'block';
    emailStatus.style.backgroundColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
    emailStatus.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
    emailStatus.style.border = `1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'}`;
  }
});
})();

// ===== 6) PDF Medication Search =====
(function setupPDFSearch() {
// Set PDF.js worker
if (typeof pdfjsLib !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

// PDF URLs for medication/formulary search functionality only (hidden from users)
// These are separate formulary PDFs used internally for the search engine
// The complete formulary is already included at the end of each benefits brochure
const PLAN_PDF_URLS = {
  manhattan: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763145497/rux6q1guicvol6mc1zns.pdf', // Affordable Choice Elite
  hcs: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1769395006/q5wyhgsmibkjyqvccovp.pdf', // UHC Premier 5000
  three: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1762960984/plod51dzlidnyqdizrza.pdf', // GIGCARE 2500 DEDUCTIBLE
  five: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763390940/uv2iqrpdkiqemqiu2zna.pdf', // GIGCARE 7350 DEDUCTIBLE
  silver: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763212557/bccvet8gjflmpqexqqmc.pdf', // LifeX VL 500 Deductible
  iec: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763391930/j1vaq2ugh9khbfzqydqx.pdf', // LifeX MM 500 Deductible
  seven: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1763212065/ytplxbkd5wn2xey8futk.pdf', // LifeX 7250 Deductible
  psm: 'https://res.cloudinary.com/dpbrqg7uz/image/upload/v1762960983/rjq9d5b13oixaseuchqw.pdf', // Maxguard 300 Deductible
};


let currentPDF = null;
let pdfTextCache = null;

// Load PDF and extract text
async function loadPDF(pdfUrl) {
  if (!pdfUrl || typeof pdfjsLib === 'undefined') {
    return null;
  }
  
  // Add cache-buster to ensure fresh PDF fetch from Cloudinary
  const cachedUrl = addCacheBuster(pdfUrl);
  
  try {
    const loadingTask = pdfjsLib.getDocument(cachedUrl);
    currentPDF = await loadingTask.promise;
    pdfTextCache = null; // Clear cache
    return currentPDF;
  } catch (error) {
    console.error('Error loading PDF:', error);
    return null;
  }
}

// Extract all text from PDF
async function extractPDFText(pdf) {
  if (!pdf) return '';
  if (pdfTextCache) return pdfTextCache;
  
  try {
    let fullText = '';
    const numPages = pdf.numPages;
    
    for (let pageNum = 1; pageNum <= numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      fullText += pageText + ' ';
    }
    
    pdfTextCache = fullText.toLowerCase();
    return pdfTextCache;
  } catch (error) {
    console.error('Error extracting PDF text:', error);
    return '';
  }
}

// Search for medication in PDF
async function searchMedicationInPDF(medicationName) {
  if (!medicationName || !medicationName.trim()) {
    return { found: false, message: 'Please enter a medication name.' };
  }
  
  const searchTerm = medicationName.trim().toLowerCase();
  const planKey = window.activePlanKey || 'psm';
  
  // Don't search for plans that don't have medication search
  if (planKey === 'manhattan' || planKey === 'hcs') {
    return { found: false, message: 'Medication search not available for this plan.' };
  }
  
  const pdfUrl = PLAN_PDF_URLS[planKey];
  
  if (!pdfUrl) {
    return { found: false, message: 'PDF not available for this plan.' };
  }
  
  try {
    // Load PDF if not already loaded or if plan changed
    // Note: PDF.js may have CORS restrictions with Adobe Acrobat links
    // User may need to host PDFs on their own server or use direct PDF URLs
    const pdf = await loadPDF(pdfUrl);
    if (!pdf) {
      return { found: false, message: 'Unable to load PDF. The PDF may need to be hosted on a CORS-enabled server.' };
    }
    
    // Extract text and search
    const pdfText = await extractPDFText(pdf);
    if (!pdfText) {
      return { found: false, message: 'Unable to read PDF content.' };
    }
    
    // Search for medication (case-insensitive, word boundary aware)
    const searchRegex = new RegExp(`\\b${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
    const found = searchRegex.test(pdfText);
    
    // Also try partial match for common variations
    const partialMatch = pdfText.includes(searchTerm);
    
    if (found || partialMatch) {
      return { 
        found: true, 
        message: `✓ "${medicationName}" appears to be covered in this plan's formulary.`,
        exactMatch: found
      };
    } else {
      return { 
        found: false, 
        message: `✗ "${medicationName}" was not found in this plan's formulary. It may not be covered.` 
      };
    }
  } catch (error) {
    console.error('PDF search error:', error);
    return { found: false, message: 'Error searching PDF. Please try again later.' };
  }
}

// Setup medication search UI
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('medication-search-input');
  const searchBtn = document.getElementById('medication-search-btn');
  const searchResult = document.getElementById('medication-search-result');
  
  if (!searchInput || !searchBtn || !searchResult) return;
  
  // Search button click
  searchBtn.addEventListener('click', async () => {
    const medication = searchInput.value.trim();
    if (!medication) {
      searchResult.style.display = 'block'; // Ensure result div is visible
      searchResult.textContent = 'Please enter a medication name.';
      searchResult.style.backgroundColor = '#fff3cd';
      searchResult.style.color = '#856404';
      searchResult.style.border = '1px solid #ffeaa7';
      return;
    }
    
    // Show loading state
    searchBtn.disabled = true;
    searchBtn.textContent = 'Searching...';
    searchResult.style.display = 'block'; // Ensure result div is visible
    searchResult.textContent = 'Searching PDF...';
    searchResult.style.backgroundColor = '#d1ecf1';
    searchResult.style.color = '#0c5460';
    searchResult.style.border = '1px solid #bee5eb';
    
    // Perform search
    const result = await searchMedicationInPDF(medication);
    
    // Display result
    searchResult.style.display = 'block'; // Ensure result div is visible
    searchResult.textContent = result.message;
    if (result.found) {
      searchResult.style.backgroundColor = '#d4edda';
      searchResult.style.color = '#155724';
      searchResult.style.border = '1px solid #c3e6cb';
    } else {
      searchResult.style.backgroundColor = '#f8d7da';
      searchResult.style.color = '#721c24';
      searchResult.style.border = '1px solid #f5c6cb';
    }
    
    // Reset button
    searchBtn.disabled = false;
    searchBtn.textContent = 'Search';
  });
  
  // Allow Enter key to trigger search
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchBtn.click();
    }
  });
  
  // Update active plan key when plan popup opens
  const originalOpenHandler = window.openModal;
  window.openModal = function(id) {
    if (id === 'plan-popup') {
      // Plan key is set in the popup open handler
      // We'll update it when prices are calculated
    }
    if (originalOpenHandler) originalOpenHandler(id);
  };
});

// Store active plan key globally for PDF search
const originalPlanOpen = document.querySelectorAll;
document.addEventListener('DOMContentLoaded', () => {
  const planButtons = document.querySelectorAll('.btn[data-plan]');
  planButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      window.activePlanKey = btn.dataset.plan;
    });
  });
});
})();
document.addEventListener('click', function (e) {
    if (e.target.closest('.price-card')) {

        showEmailModal();
    }
});

function myHintPopup(action, header = '', body = '', footer = '') {
  const overlay = document.getElementById('myHintPopupOverlay');
  const headerEl = document.getElementById('hintHeader');
  const bodyEl = document.getElementById('hintBody');
  const footerEl = document.getElementById('hintFooter');

  if (action === 'open') {
    headerEl.innerHTML = header || '';
    bodyEl.innerHTML = body || '';

    // Bind click to any plan links dynamically inserted
    const planLinks = bodyEl.querySelectorAll('.open-popup[data-plan]');
    planLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const planKey = link.dataset.plan;
        console.log('Hint popup link clicked, opening plan:', planKey);

        // Find the actual plan button on the page
        const planBtn = document.querySelector(`.btn[data-plan="${planKey}"]`);
        if (planBtn) {
          planBtn.click(); // simulate click on the plan button
        } else if (window.openPlanPopup) {
          // fallback global helper if exists
          window.openPlanPopup(planKey);
        }

        // Close the hint popup
        myHintPopup('close');
      });
    });

    if (footer) {
      footerEl.innerHTML = footer;
      footerEl.style.display = 'block';
    } else {
      footerEl.style.display = 'none';
    }

    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // prevent background scroll
  }

  if (action === 'close') {
    overlay.style.display = 'none';
    document.body.style.overflow = '';
  }
}
